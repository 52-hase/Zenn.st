---
title: "Googleãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ï¼ˆdevise + omniauthï¼‰"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Googleãƒ­ã‚°ã‚¤ãƒ³, devise, omniauth]
published: true
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### è¡Œã„ãŸã„ã“ã¨
- deviseã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…ã«ã€Googleãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹ã€‚

### å‰æã¨ã—ã¦
- æ—¢ã«deviseã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…ãŒã§ãã¦ã„ã‚‹
- Herokuã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿

# Googleã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å–å¾—
ãƒ»ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‹ã‚‰
https://zenn.dev/tteaoocl/articles/5601b28fa8045d


# Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```:Gemfile
gem 'omniauth-google-oauth2'
gem 'omniauth-rails_csrf_protection'
```

:::details omniauth-google-oauth2
Googleã®`OAuth2`ã‚’åˆ©ç”¨ã—ãŸèªè¨¼ã‚’æä¾›ã™ã‚‹ãŸã‚ã®Gemã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
:::
:::details omniauth-rails_csrf_protection
Railsã§`OmniAuth`ã‚’ä½¿ç”¨ã™ã‚‹éš›ã®`CSRFï¼ˆCross-Site Request Forgeryï¼‰`æ”»æ’ƒã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®Gemã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ã€‚
:::

# omniauthç”¨ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ bin/rails g migration AddOmniauthToUsers provider:string uid:string
$ bin/rails g migration AddIndexUidAndProviderToUsers
```
:::details è¿½åŠ ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ï¼ˆAddOmniauthToUsers provider:string uid:stringï¼‰
usersãƒ†ãƒ¼ãƒ–ãƒ«ã«`provider`ã¨`uid`ã®2ã¤ã®ã‚«ãƒ©ãƒ ãŒè¿½åŠ ã•ã‚Œã¾ã™
```:db/schema.rb
t.string "provider"
t.string "uid"
```
:::
:::details ã‚«ãƒ©ãƒ ã«ä¸€æ„ã®åˆ¶ç´„ï¼ˆAddIndexUidAndProviderToUsersï¼‰
usersãƒ†ãƒ¼ãƒ–ãƒ«ã®`uid`ã¨`provider`ã«`ä¸€æ„ã®åˆ¶ç´„`ã‚’è¨­å®šã™ã‚‹
```:db/schema.rb
t.index ["uid", "provider"], name: "index_users_on_uid_and_provider", unique: true
```
:::

# ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¨˜è¼‰
## .env ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã™ã‚‹ï¼ˆéš ã—ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
ãƒ»ä½œæˆã—ãŸ`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID`ã¨`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ`ã‚’`.env`ã«è¨˜è¼‰ã™ã‚‹
```:.env
GOOGLE_CLIENT_ID=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
GOOGLE_CLIENT_SECRET=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
```
## config/initializers/devise.rb ã«OmniAuthã®è¨­å®šã‚’è¨˜è¼‰ã™ã‚‹

```:config/initializers/devise.rb
config.omniauth :google_oauth2, ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET']
```
:::details å½¹å‰²
ãƒ»`config.omniauth`
deviseã«OmniAuthã®è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚OmniAuthã‚’ä½¿ã£ã¦å¤–éƒ¨ã®èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨é€£æºã™ã‚‹ã€‚
ãƒ»`google_oauth2`
OmniAuthã§Googleã®OAuth2ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’æŒ‡å®šã™ã‚‹è¨­å®šã€‚ã“ã®è¨­å®šã«ã‚ˆã‚Šã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ãŸ`OAuth2èªè¨¼`ãŒå¯èƒ½ã«ãªã‚‹ã€‚
ãƒ»`ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET']`
ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ã€‚ã‚³ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ä¿å®ˆæ€§ãŒå‘ä¸Šã™ã‚‹ã€‚
:::
## routes.rb ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šã‚’ã™ã‚‹

```:config/routes.rb
devise_for :users, controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
```
:::details controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
`OmniAuth`ã®èªè¨¼ãŒæˆåŠŸã—ãŸã¨ãã«ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦`Users::OmniauthCallbacksController`ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹è¨­å®š
(`devise_for :users`ã¯deviseã®å®Ÿè£…æ™‚ã«è¨˜è¼‰ã•ã‚ŒãŸã‚‚ã®)
:::

## omniauth_callbacks_controller.rb è¨˜è¼‰ã‚’ã™ã‚‹
ãƒ»`app/controllers/users/`ã«`omniauth_callbacks_controller.rb`ã‚’ä½œæˆã™ã‚‹
ãƒ»ä»¥ä¸‹ã®æ§˜ã«è¨˜è¼‰ã™ã‚‹

```:app/controllers/users/omniauth_callbacks_controller.rb
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
  skip_before_action :verify_authenticity_token, only: :google_oauth2

  def google_oauth2
    callback_for(:google)
  end

  def callback_for(provider)
    @user = User.from_omniauth(request.env['omniauth.auth'])

    if @user.persisted?
      sign_in_and_redirect @user, event: :authentication
      set_flash_message(:notice, :success, kind: provider.to_s.capitalize) if is_navigational_format?
    else
      session["devise.#{provider}_data"] = request.env['omniauth.auth'].except(:extra)
      redirect_to new_user_registration_url
    end
  end

  def failure
    redirect_to root_path
  end
end
```

## user.rb ã«è¨˜è¼‰ã™ã‚‹
:::details app/models/user.rbã®è¨˜è¼‰ã‚³ãƒ¼ãƒ‰
```:app/models/user.rb
class User < ApplicationRecord
  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable,
         :omniauthable, omniauth_providers: [:google_oauth2]

         has_many :live_room
         has_many :messages
         validates :name, presence: true
         validates :name, presence: true, uniqueness: { case_sensitive: false }

         has_one_attached :avatar
         attr_accessor :remove_avatar

         validates :uid, presence: true, uniqueness: { scope: :provider }, if: -> { uid.present? }

  def self.from_omniauth(auth)
    where(provider: auth.provider, uid: auth.uid).first_or_create do |user|
      user.name = auth.info.name
      user.email = auth.info.email
      user.password = Devise.friendly_token[0, 20]
    end
  end

  def self.create_unique_string
    SecureRandom.uuid
  end
end
```
:::
ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨˜è¼‰ï¼ˆdeviseã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®å¾Œã‚ã«è¿½è¨˜ã™ã‚‹ï¼‰
`:omniauthable, omniauth_providers: [:google_oauth2]`
```:app/models/user.rb
devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable,
         :omniauthable, omniauth_providers: [:google_oauth2]
```
:::details :omniauthable, omniauth_providers: [:google_oauth2]
ãƒ»`:omniauthable`
deviseã«OmniAuthã‚’çµ±åˆã—ã€å¤–éƒ¨ã®OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

ãƒ»`omniauth_providers: [:google_oauth2]`
ä½¿ç”¨ã™ã‚‹OmniAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã€‚
:::

ãƒ»`from_omniauthãƒ¡ã‚½ãƒƒãƒ‰`ã®è¨˜è¼‰
```:app/models/user.rb
def self.from_omniauth(auth)
  where(provider: auth.provider, uid: auth.uid).first_or_create do |user|
    user.name = auth.info.name
    user.email = auth.info.email
    user.password = Devise.friendly_token[0, 20]
  end
end
```
:::details from_omniauthãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦
ãƒ»`provider`ã¨`uid`ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã—ã€å­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦ä½œæˆã™ã‚‹ã€‚
ãƒ»æ–°è¦ä½œæˆæ™‚ã«ã¯`name`ã€`email`ã€`password`ã‚’è¨­å®šã—ã¦ã„ã‚‹ã€‚
:::

ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨˜è¼‰
```:app/models/user.rb
validates :uid, presence: true, uniqueness: { scope: :provider }, if: -> { uid.present? }
```
:::details :uid, presence: true, uniqueness: { scope: :provider }, if: -> { uid.present? }
ãƒ»`uid`ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã€ãã®ä¸€æ„æ€§ã‚’`provider`ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ç¢ºèªã™ã‚‹

[ä¾‹]
ã€`provider: 'google',` `uid: '12345'`ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€

ãƒ»`provider: 'google'`, `uid: '12345'`ã®æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€
ã€€ä¸€æ„æ€§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã™ã€‚
ãƒ»`provider: 'facebook'`, `uid: '12345'`ã®æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚
:::

ãƒ»`create_unique_stringãƒ¡ã‚½ãƒƒãƒ‰`ã®è¨˜è¼‰
```:app/models/user.rb
def self.create_unique_string
    SecureRandom.uuid
  end
```
:::details create_unique_stringãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦
ãƒ»ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ–‡å­—åˆ—ï¼ˆ`UUID`ï¼‰ã‚’ç”Ÿæˆã™ã‚‹ã€‚
ãƒ»`UUID`ã¯ä¸€æ„æ€§ãŒé«˜ã„ãŸã‚ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè­˜åˆ¥å­ãŒå¿…è¦ãªå ´åˆã«ä½¿ã‚ã‚Œã‚‹ã€‚
:::

# registrations_controller.rb ã‚’è¨˜è¼‰ã™ã‚‹
ãƒ»`app/controllers/users/`ã«`registrations_controller.rb`ã‚’ä½œæˆã™ã‚‹
ãƒ»ä»¥ä¸‹ã®æ§˜ã«è¨˜è¼‰ã™ã‚‹

```:app/controllers/users/registrations_controller.rb
class Users::RegistrationsController < Devise::RegistrationsController
  def build_resource(hash = {})
    hash[:uid] = User.create_unique_string
    super
  end

  def update_resource(resource, params)
    return super if params['password'].present?
  
    resource.update_without_password(params.except('current_password'))
  end
end
```

# Googleãƒ­ã‚°ã‚¤ãƒ³ã§å¤±æ•—ã—ãŸã¨ãã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ãŸã‚ã®è¿½è¨˜

ãƒ»`omniauth_callbacks_controller.rb`ã®ä»¥ä¸‹ã®ç®‡æ‰€ãŒã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨˜è¼‰ã«ãªã‚Šã¾ã™
```:app/controllers/users/omniauth_callbacks_controller.rb
flash[:alert] = @user.errors.full_messages.to_sentence if @user.errors.any?
```

ãƒ»viewãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã§ãã‚‹æ§˜ã«è¿½è¨˜
```:app/views/devise/registrations/new.html.erb
<% if flash[:alert] %>
  <div class="custom-alert">
    <span class="close" onclick="this.parentElement.style.display='none';">&times;</span>
    <%= flash[:alert] %>
  </div>
<% end %>
```

ãƒ»è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¦‹ãŸç›®ã‚’ä¿®æ­£
:::details è¡¨ç¤ºä¾‹
[![Image from Gyazo](https://i.gyazo.com/68bfd097cb5a5ac290e547d5d57cd118.png =600x)](https://gyazo.com/68bfd097cb5a5ac290e547d5d57cd118)
:::
ãƒ»`app/assets/stylesheets/`ã«`custom_alerts.css`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®æ§˜ã«è¨˜è¼‰ã™ã‚‹
```:app/assets/stylesheets/custom_alerts.css
.custom-alert {
  padding: 15px;
  background-color: #f44336; /* èµ¤è‰² */
  color: white;
  margin-bottom: 20px;
  border-radius: 5px;
  font-size: 16px;
}

.custom-alert .close {
  margin-left: 15px;
  color: white;
  font-weight: bold;
  float: right;
  font-size: 22px;
  line-height: 20px;
  cursor: pointer;
  transition: 0.3s;
}

.custom-alert .close:hover {
  color: black;
}
```
ãƒ»`custom_alerts.scss`ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹æ§˜ã«è¨˜è¼‰ã™ã‚‹
```:app/assets/stylesheets/application.bootstrap.scss
@import 'custom_alerts';
```

# Herokuã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰
`.env`ã«è¨˜è¼‰ã—ãŸ`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID`ã¨`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ`ã‚’Herokuå´ã«ã‚‚è¨­å®šã™ã‚‹
ãƒ»Herokuã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€`è¨­å®š`â‡¨`è¨­å®šå¤‰æ•°ã€€`â‡¨`éµ`ã¨`ä¾¡å€¤`ã«å€¤ã‚’å…¥åŠ›ã—`è¿½åŠ `
[![Image from Gyazo](https://i.gyazo.com/914ec4a813e92fe2e3fdebfd27d68212.png =700x)](https://gyazo.com/914ec4a813e92fe2e3fdebfd27d68212)
ãƒ»`éµ`ã¨`ä¾¡å€¤`ã«å€¤ã‚’å…¥åŠ›ã—`è¿½åŠ `
[![Image from Gyazo](https://i.gyazo.com/6e65aa2a63db2e789ddfd5d8473d18ae.png)](https://gyazo.com/6e65aa2a63db2e789ddfd5d8473d18ae)
ãƒ»`ç’°å¢ƒå¤‰æ•°`ã‚’è¨˜è¼‰ï¼ˆ`.env`ãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã«æ­£ã—ãè¨˜è¼‰ï¼‰
[![Image from Gyazo](https://i.gyazo.com/10c68bfc58c696fb619fc7bf0b001490.png =500x)](https://gyazo.com/10c68bfc58c696fb619fc7bf0b001490)


### ä»¥ä¸Šã§é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ã®ã€Googleãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ã¯çµ‚äº†ã§ã™ã€‚