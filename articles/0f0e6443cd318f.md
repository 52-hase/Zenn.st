---
title: "Googleログインの実装（devise + omniauth）"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Googleログイン, devise, omniauth]
published: false
---
### 開発環境
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### 行いたいこと
- deviceによるログイン機能の実装に加え、Googleログインの実装を追加する。

### 前提として
- 既にdeviseによるログイン機能の実装ができている
- Herokuにはデプロイ済み

# GoogleのクライアントIDとクライアントシークレットの取得
・こちらのリンクから
https://zenn.dev/tteaoocl/articles/5601b28fa8045d


# Gemのインストール

```:Gemfile
gem 'omniauth-google-oauth2'
gem 'omniauth-rails_csrf_protection'
```

:::details omniauth-google-oauth2
Googleの`OAuth2`を利用した認証を提供するためのGem。ユーザーがGoogleアカウントでサインインできるようにする。
:::
:::details omniauth-rails_csrf_protection
Railsで`OmniAuth`を使用する際の`CSRF（Cross-Site Request Forgery）`攻撃からアプリケーションを保護するためのGem。セキュリティを強化する。
:::

# omniauth用のカラムを追加

```:ターミナル
$ bin/rails g migration AddOmniauthToUsers provider:string uid:string
$ bin/rails g migration AddIndexUidAndProviderToUsers
```
:::details 追加されるカラム（AddOmniauthToUsers provider:string uid:string）
usersテーブルに`provider`と`uid`の2つのカラムが追加されます
:::
:::details カラムに一意の制約（AddIndexUidAndProviderToUsers）
usersテーブルの`uid`と`provider`に`一意の制約`を設定する
:::

# ファイルへの記載
## .env に環境変数を記載する（隠しファイル）
・作成した`クライアントID`と`クライアントシークレット`を`.env`に記載する
```:.env
GOOGLE_CLIENT_ID=クライアントID
GOOGLE_CLIENT_SECRET=クライアントシークレット
```
## config/initializers/devise.rb　にOmniAuthの設定を記載する

```:config/initializers/devise.rb
config.omniauth :google_oauth2, ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET']
```

## routes.rb にルーティングの設定をする

```
devise_for :users, controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
```
:::details controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
`OmniAuth`の認証が成功したときに、コールバックとして`Users::OmniauthCallbacksController`が呼び出されるようにする設定
(`devise_for :users`はdeviseの実装時に記載されたもの)
:::

## omniauth_callbacks_controller.rb 記載をする
・`app/controllers/users/`に`omniauth_callbacks_controller.rb`を作成する

```:app/controllers/users/omniauth_callbacks_controller.rb
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
  skip_before_action :verify_authenticity_token, only: :google_oauth2

  def google_oauth2
    callback_for(:google)
  end

  def callback_for(provider)
    @user = User.from_omniauth(request.env['omniauth.auth'])

    if @user.persisted?
      sign_in_and_redirect @user, event: :authentication
      set_flash_message(:notice, :success, kind: provider.to_s.capitalize) if is_navigational_format?
    else
      session["devise.#{provider}_data"] = request.env['omniauth.auth'].except(:extra)
      redirect_to new_user_registration_url
    end
  end

  def failure
    redirect_to root_path
  end
end
```
