---
title: "Googleãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ï¼ˆdevise + omniauthï¼‰"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Googleãƒ­ã‚°ã‚¤ãƒ³, devise, omniauth]
published: false
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### è¡Œã„ãŸã„ã“ã¨
- deviceã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…ã«åŠ ãˆã€Googleãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹ã€‚

### å‰æã¨ã—ã¦
- æ—¢ã«deviseã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…ãŒã§ãã¦ã„ã‚‹
- Herokuã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿

# Googleã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å–å¾—
ãƒ»ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‹ã‚‰
https://zenn.dev/tteaoocl/articles/5601b28fa8045d


# Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```:Gemfile
gem 'omniauth-google-oauth2'
gem 'omniauth-rails_csrf_protection'
```

:::details omniauth-google-oauth2
Googleã®`OAuth2`ã‚’åˆ©ç”¨ã—ãŸèªè¨¼ã‚’æä¾›ã™ã‚‹ãŸã‚ã®Gemã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
:::
:::details omniauth-rails_csrf_protection
Railsã§`OmniAuth`ã‚’ä½¿ç”¨ã™ã‚‹éš›ã®`CSRFï¼ˆCross-Site Request Forgeryï¼‰`æ”»æ’ƒã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®Gemã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ã€‚
:::

# omniauthç”¨ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ bin/rails g migration AddOmniauthToUsers provider:string uid:string
$ bin/rails g migration AddIndexUidAndProviderToUsers
```
:::details è¿½åŠ ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ï¼ˆAddOmniauthToUsers provider:string uid:stringï¼‰
usersãƒ†ãƒ¼ãƒ–ãƒ«ã«`provider`ã¨`uid`ã®2ã¤ã®ã‚«ãƒ©ãƒ ãŒè¿½åŠ ã•ã‚Œã¾ã™
:::
:::details ã‚«ãƒ©ãƒ ã«ä¸€æ„ã®åˆ¶ç´„ï¼ˆAddIndexUidAndProviderToUsersï¼‰
usersãƒ†ãƒ¼ãƒ–ãƒ«ã®`uid`ã¨`provider`ã«`ä¸€æ„ã®åˆ¶ç´„`ã‚’è¨­å®šã™ã‚‹
:::

# ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¨˜è¼‰
## .env ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã™ã‚‹ï¼ˆéš ã—ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
ãƒ»ä½œæˆã—ãŸ`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID`ã¨`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ`ã‚’`.env`ã«è¨˜è¼‰ã™ã‚‹
```:.env
GOOGLE_CLIENT_ID=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
GOOGLE_CLIENT_SECRET=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
```
## config/initializers/devise.rbã€€ã«OmniAuthã®è¨­å®šã‚’è¨˜è¼‰ã™ã‚‹

```:config/initializers/devise.rb
config.omniauth :google_oauth2, ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET']
```

## routes.rb ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šã‚’ã™ã‚‹

```
devise_for :users, controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
```
:::details controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
`OmniAuth`ã®èªè¨¼ãŒæˆåŠŸã—ãŸã¨ãã«ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦`Users::OmniauthCallbacksController`ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹è¨­å®š
(`devise_for :users`ã¯deviseã®å®Ÿè£…æ™‚ã«è¨˜è¼‰ã•ã‚ŒãŸã‚‚ã®)
:::

## omniauth_callbacks_controller.rb è¨˜è¼‰ã‚’ã™ã‚‹
ãƒ»`app/controllers/users/`ã«`omniauth_callbacks_controller.rb`ã‚’ä½œæˆã™ã‚‹

```:app/controllers/users/omniauth_callbacks_controller.rb
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
  skip_before_action :verify_authenticity_token, only: :google_oauth2

  def google_oauth2
    callback_for(:google)
  end

  def callback_for(provider)
    @user = User.from_omniauth(request.env['omniauth.auth'])

    if @user.persisted?
      sign_in_and_redirect @user, event: :authentication
      set_flash_message(:notice, :success, kind: provider.to_s.capitalize) if is_navigational_format?
    else
      session["devise.#{provider}_data"] = request.env['omniauth.auth'].except(:extra)
      redirect_to new_user_registration_url
    end
  end

  def failure
    redirect_to root_path
  end
end
```
