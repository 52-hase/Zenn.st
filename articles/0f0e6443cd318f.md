---
title: "Googleãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ï¼ˆdevise + omniauthï¼‰"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Googleãƒ­ã‚°ã‚¤ãƒ³, devise, omniauth]
published: false
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### è¡Œã„ãŸã„ã“ã¨
- deviseã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…ã«åŠ ãˆã€Googleãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹ã€‚

### å‰æã¨ã—ã¦
- æ—¢ã«deviseã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…ãŒã§ãã¦ã„ã‚‹
- Herokuã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿

# Googleã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å–å¾—
ãƒ»ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‹ã‚‰
https://zenn.dev/tteaoocl/articles/5601b28fa8045d


# Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```:Gemfile
gem 'omniauth-google-oauth2'
gem 'omniauth-rails_csrf_protection'
```

:::details omniauth-google-oauth2
Googleã®`OAuth2`ã‚’åˆ©ç”¨ã—ãŸèªè¨¼ã‚’æä¾›ã™ã‚‹ãŸã‚ã®Gemã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
:::
:::details omniauth-rails_csrf_protection
Railsã§`OmniAuth`ã‚’ä½¿ç”¨ã™ã‚‹éš›ã®`CSRFï¼ˆCross-Site Request Forgeryï¼‰`æ”»æ’ƒã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®Gemã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ã€‚
:::

# omniauthç”¨ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ bin/rails g migration AddOmniauthToUsers provider:string uid:string
$ bin/rails g migration AddIndexUidAndProviderToUsers
```
:::details è¿½åŠ ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ï¼ˆAddOmniauthToUsers provider:string uid:stringï¼‰
usersãƒ†ãƒ¼ãƒ–ãƒ«ã«`provider`ã¨`uid`ã®2ã¤ã®ã‚«ãƒ©ãƒ ãŒè¿½åŠ ã•ã‚Œã¾ã™
```
t.string "provider"
t.string "uid"
```
:::
:::details ã‚«ãƒ©ãƒ ã«ä¸€æ„ã®åˆ¶ç´„ï¼ˆAddIndexUidAndProviderToUsersï¼‰
usersãƒ†ãƒ¼ãƒ–ãƒ«ã®`uid`ã¨`provider`ã«`ä¸€æ„ã®åˆ¶ç´„`ã‚’è¨­å®šã™ã‚‹
```
t.index ["uid", "provider"], name: "index_users_on_uid_and_provider", unique: true
```
:::

# ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¨˜è¼‰
## .env ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã™ã‚‹ï¼ˆéš ã—ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
ãƒ»ä½œæˆã—ãŸ`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID`ã¨`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ`ã‚’`.env`ã«è¨˜è¼‰ã™ã‚‹
```:.env
GOOGLE_CLIENT_ID=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
GOOGLE_CLIENT_SECRET=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
```
## config/initializers/devise.rbã€€ã«OmniAuthã®è¨­å®šã‚’è¨˜è¼‰ã™ã‚‹

```:config/initializers/devise.rb
config.omniauth :google_oauth2, ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET']
```

## routes.rb ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šã‚’ã™ã‚‹

```
devise_for :users, controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
```
:::details controllers: { omniauth_callbacks: 'users/omniauth_callbacks' }
`OmniAuth`ã®èªè¨¼ãŒæˆåŠŸã—ãŸã¨ãã«ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦`Users::OmniauthCallbacksController`ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹è¨­å®š
(`devise_for :users`ã¯deviseã®å®Ÿè£…æ™‚ã«è¨˜è¼‰ã•ã‚ŒãŸã‚‚ã®)
:::

## omniauth_callbacks_controller.rb è¨˜è¼‰ã‚’ã™ã‚‹
ãƒ»`app/controllers/users/`ã«`omniauth_callbacks_controller.rb`ã‚’ä½œæˆã™ã‚‹
ãƒ»ä»¥ä¸‹ã®æ§˜ã«è¨˜è¼‰ã™ã‚‹

```:app/controllers/users/omniauth_callbacks_controller.rb
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
  skip_before_action :verify_authenticity_token, only: :google_oauth2

  def google_oauth2
    callback_for(:google)
  end

  def callback_for(provider)
    @user = User.from_omniauth(request.env['omniauth.auth'])

    if @user.persisted?
      sign_in_and_redirect @user, event: :authentication
      set_flash_message(:notice, :success, kind: provider.to_s.capitalize) if is_navigational_format?
    else
      session["devise.#{provider}_data"] = request.env['omniauth.auth'].except(:extra)
      redirect_to new_user_registration_url
    end
  end

  def failure
    redirect_to root_path
  end
end
```

## user.rb ã«è¨˜è¼‰ã™ã‚‹
ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨˜è¼‰ï¼ˆdeviseã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®å¾Œã‚ã«è¿½è¨˜ã™ã‚‹ï¼‰
`:omniauthable, omniauth_providers: [:google_oauth2]`
```
devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable,
         :omniauthable, omniauth_providers: [:google_oauth2]
```
:::details :omniauthable, omniauth_providers: [:google_oauth2]
ãƒ»`:omniauthable`
deviseã«OmniAuthã‚’çµ±åˆã—ã€å¤–éƒ¨ã®OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

ãƒ»`omniauth_providers: [:google_oauth2]`
ä½¿ç”¨ã™ã‚‹OmniAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã€‚
:::

ãƒ»`from_omniauthãƒ¡ã‚½ãƒƒãƒ‰`ã®è¨˜è¼‰
```
def self.from_omniauth(auth)
  where(provider: auth.provider, uid: auth.uid).first_or_create do |user|
    user.name = auth.info.name
    user.email = auth.info.email
    user.password = Devise.friendly_token[0, 20]
  end
end
```
:::details from_omniauthãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦
ãƒ»`provider`ã¨`uid`ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã—ã€å­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦ä½œæˆã™ã‚‹ã€‚
ãƒ»æ–°è¦ä½œæˆæ™‚ã«ã¯`name`ã€`email`ã€`password`ã‚’è¨­å®šã—ã¦ã„ã‚‹ã€‚
:::

ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨˜è¼‰
```
validates :uid, presence: true, uniqueness: { scope: :provider }, if: -> { uid.present? }
```
:::details :uid, presence: true, uniqueness: { scope: :provider }, if: -> { uid.present? }
ãƒ»`uid`ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã€ãã®ä¸€æ„æ€§ã‚’`provider`ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ç¢ºèªã™ã‚‹

[ä¾‹]
ã€`provider: 'google',` `uid: '12345'`ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€

ãƒ»`provider: 'google'`, `uid: '12345'`ã®æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€
ã€€ä¸€æ„æ€§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã™ã€‚
ãƒ»`provider: 'facebook'`, `uid: '12345'`ã®æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚
:::

ãƒ»`create_unique_stringãƒ¡ã‚½ãƒƒãƒ‰`ã®è¨˜è¼‰
```
def self.create_unique_string
    SecureRandom.uuid
  end
```
:::details create_unique_stringãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦
ãƒ»ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ–‡å­—åˆ—ï¼ˆ`UUID`ï¼‰ã‚’ç”Ÿæˆã™ã‚‹ã€‚
ãƒ»`UUID`ã¯ä¸€æ„æ€§ãŒé«˜ã„ãŸã‚ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè­˜åˆ¥å­ãŒå¿…è¦ãªå ´åˆã«ä½¿ã‚ã‚Œã‚‹ã€‚
:::

# registrations_controller.rb ã‚’è¨˜è¼‰ã™ã‚‹
ãƒ»`app/controllers/users/`ã«`registrations_controller.rb`ã‚’ä½œæˆã™ã‚‹
ãƒ»ä»¥ä¸‹ã®æ§˜ã«è¨˜è¼‰ã™ã‚‹

```:app/controllers/users/registrations_controller.rb
class Users::RegistrationsController < Devise::RegistrationsController
  def build_resource(hash = {})
    hash[:uid] = User.create_unique_string
    super
  end

  def update_resource(resource, params)
    return super if params['password'].present?
  
    resource.update_without_password(params.except('current_password'))
  end
end
```

