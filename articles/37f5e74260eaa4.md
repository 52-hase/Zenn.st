---
title: "Dockerã®å­¦ç¿’"
emoji: "ğŸ“˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [docker]
published: false
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
<br>
<br>







# Dockerã«ã¤ã„ã¦
#### Docker Image
ãƒ»`Docker Container`ã‚’ç”Ÿæˆã™ã‚‹æ™‚ã«`Docker Image`ã‚’ä½¿ã†
ãƒ»`Docker Image`ã¯`Docker Repository`ã¨ã„ã†æ£šã«ã‚ã‚‹ã‚ˆã†ãªæ„Ÿã˜






#### Docker Container
ãƒ»`Node.js`, `PHP`, `Laravel`ãªã©ã‚’å…¥ã‚Œã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™ç’°å¢ƒã‚’ä½œã‚‹ã€‚
ãƒ»`Docker Container`ã‚’ä½œã‚‹ã«ã¯`Docker Image`ãŒå¿…è¦
ï¼ˆä¾‹ãˆã°`Node.js ver18.5`ã®`Docker Container`ã‚’ä½œã‚ŠãŸã„å ´åˆã¯`Node.js ver18.5`ã®`Docker Image`ãŒå¿…è¦ï¼‰
ï¼ˆDocker Imageã¯ãƒ¬ã‚·ãƒ”ã§Docker Containerã¯æ–™ç†ï¼‰
ãƒ»Docker Repositoryâ‡¨Docker Imageâ‡¨Docker Container
ï¼ˆDocker Repositoryã¨ã„ã†æ£šã«Docker ImageãŒä¸¦ã‚“ã§ã„ã‚‹ï¼‰







#### Docker Repository
ãƒ»ä¾‹ã¨ã—ã¦Docker Hub, GCR, ECRãªã©
ãƒ»Repositoryã‹ã‚‰Imageã‚’å–ã£ã¦ãã¦









#### Dockerfileã¨ã¯
ãƒ»Repositoryã‹ã‚‰Imageã‚’å–ã£ã¦ãã¦Containerã‚’ä½œã‚‹ä¸€é€£ã®æµã‚Œã‚’è¨˜è¼‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
ãƒ»æ‹¡å¼µå­ãŒãªã„ãƒ•ã‚¡ã‚¤ãƒ«




:::details Dockerfile
```rb: Dockerfile
# Dockerfileã®æ§‹æ–‡ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
# DockerãŒã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦Dockerfileã‚’è§£æã™ã‚‹
# syntax = docker/dockerfile:1

# Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šï¼ˆ.ruby-version ã¨ Gemfile ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
ARG RUBY_VERSION=3.2.3
# Rubyã®ã‚¹ãƒªãƒ ç‰ˆå…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨
FROM registry.docker.com/library/ruby:$RUBY_VERSION-slim as base

# Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
WORKDIR /rails

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒå‘ã‘ï¼‰
ENV RAILS_ENV="production" \  # Railsã®ç’°å¢ƒã‚’æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
    BUNDLE_DEPLOYMENT="1" \   # Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æœ¬ç•ªå‘ã‘ã«æœ€é©åŒ–
    BUNDLE_PATH="/usr/local/bundle" \  # Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    BUNDLE_WITHOUT="development"  # æœ¬ç•ªç’°å¢ƒã§ã¯é–‹ç™ºç”¨ã®Gemã‚’é™¤å¤–

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ãƒ“ãƒ«ãƒ‰ç”¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’çœã„ã¦è»½é‡åŒ–ã™ã‚‹ï¼‰
FROM base as build

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    build-essential curl libpq-dev git libvips node-gyp pkg-config python-is-python3

# Node.jsã¨Yarnã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ARG NODE_VERSION=20.14.0
ARG YARN_VERSION=1.22.22
ENV PATH=/usr/local/node/bin:$PATH
RUN curl -sL https://github.com/nodenv/node-build/archive/master.tar.gz | tar xz -C /tmp/ && \
    /tmp/node-build-master/bin/node-build "${NODE_VERSION}" /usr/local/node && \
    npm install -g yarn@$YARN_VERSION && \
    rm -rf /tmp/node-build-master

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Gemã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE_PATH}"/ruby/*/bundler/gems/*/.git && \
    bundle exec bootsnap precompile --gemfile  # Bootsnapã‚’äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€èµ·å‹•é€Ÿåº¦ã‚’å‘ä¸Š

# Node.jsã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile  # lockfileã‚’ä½¿ç”¨ã—ã¦ä¸€è²«ã—ãŸä¾å­˜é–¢ä¿‚ã‚’ç¢ºä¿

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼
COPY . .

# Bootsnapã‚’äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦èµ·å‹•æ™‚é–“ã‚’çŸ­ç¸®
RUN bundle exec bootsnap precompile app/ lib/

# RAILS_MASTER_KEY ãªã—ã§ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼ˆãƒ€ãƒŸãƒ¼ã‚­ãƒ¼ã‚’ä½¿ç”¨ï¼‰
RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æœ¬ç•ªç’°å¢ƒå‘ã‘ã®æœ€çµ‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆ
FROM base

# æœ¬ç•ªç’°å¢ƒã§å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    curl default-postgresql-client libvips && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã§ã‚µã‚¤ã‚ºå‰Šæ¸›

# ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚³ãƒ”ãƒ¼
COPY --from=build /usr/local/bundle /usr/local/bundle  # Gemãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=build /rails /rails  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œ
RUN useradd rails --create-home --shell /bin/bash && \
    chown -R rails:rails db log storage tmp  # æ¨©é™ã‚’railsãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´
USER rails:rails

# Entrypointã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è‡ªå‹•åŒ–ï¼‰
ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Railsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒ¼ãƒˆã‚’å…¬é–‹
EXPOSE 3000

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚³ãƒãƒ³ãƒ‰ï¼ˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼‰
CMD ["./bin/rails", "server"]
```








#### Docker Compose
ãƒ»è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’æèµ·ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãªã©ï¼‰



:::details compose.yml
```rb:compose.yml
services:
  db: # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã®å®šç¾©
    image: postgres:latest # PostgreSQLã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    environment: # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
      POSTGRES_PASSWORD: myapp_password # PostgreSQLã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
      TZ: Asia/Tokyo # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ—¥æœ¬æ™‚é–“ã«è¨­å®š
    volumes:
      - postgres_data:/var/lib/postgresql/data # ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ç”¨ãƒœãƒªãƒ¥ãƒ¼ãƒ 
    ports:
      - 5432:5432 # ãƒ›ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ†ãƒŠé–“ã§PostgreSQLã®ãƒãƒ¼ãƒˆã‚’å…¬é–‹
    healthcheck: # ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š
      test: ["CMD-SHELL", "pg_isready -U postgres"] # PostgreSQLãŒèµ·å‹•æº–å‚™å®Œäº†ã‹ç¢ºèª
      interval: 10s # 10ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
      timeout: 10s # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ10ç§’
      retries: 3 # 3å›è©¦è¡Œ
      start_period: 30s # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‹ã‚‰30ç§’é–“ã¯ãƒã‚§ãƒƒã‚¯ã‚’å¾…æ©Ÿ

  web: # Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Webã‚µãƒ¼ãƒ“ã‚¹å®šç¾©
    build:
      context: . # Dockerãƒ“ãƒ«ãƒ‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
      dockerfile: Dockerfile.dev # é–‹ç™ºç”¨ã®Dockerfileã‚’æŒ‡å®š
    command: bash -c "bundle install && bundle exec rails db:prepare && rm -f tmp/pids/server.pid && ./bin/dev"
    # - `bundle install` ã§ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    # - `bundle exec rails db:prepare` ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™
    # - `rm -f tmp/pids/server.pid` ã§ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®PIDãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆRailså†èµ·å‹•æ™‚ã®ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
    # - `./bin/dev` ã§é–‹ç™ºç”¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’èµ·å‹•

    tty: true # ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’æœ‰åŠ¹åŒ–
    stdin_open: true # æ¨™æº–å…¥åŠ›ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®å¯¾è©±çš„ãªæ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹ï¼‰
    volumes:
      - .:/myapp # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã® `/myapp` ã«ãƒã‚¦ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¤‰æ›´ã‚’åæ˜ ï¼‰
      - bundle_data:/usr/local/bundle:cached # Gemã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ°¸ç¶šåŒ–
      - node_modules:/myapp/node_modules # Node.jsã®ä¾å­˜é–¢ä¿‚ã‚’æ°¸ç¶šåŒ–
    environment:
      TZ: Asia/Tokyo # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ—¥æœ¬æ™‚é–“ã«è¨­å®š
    ports:
      - "3000:3000" # ãƒ›ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ†ãƒŠé–“ã§Railsã®ãƒãƒ¼ãƒˆã‚’å…¬é–‹
    depends_on: # ä¾å­˜é–¢ä¿‚ã®è¨­å®šï¼ˆdbã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ã‚’å¾…ã¤ï¼‰
      db:
        condition: service_healthy # dbã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã™ã‚‹ã¾ã§å¾…æ©Ÿ

volumes:
  postgres_data: # PostgreSQLã®ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ç”¨ãƒœãƒªãƒ¥ãƒ¼ãƒ 
  bundle_data: # Rubyã®Gemã‚’ä¿å­˜ã™ã‚‹ãƒœãƒªãƒ¥ãƒ¼ãƒ 
  node_modules: # Node.jsã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¿å­˜ã™ã‚‹ãƒœãƒªãƒ¥ãƒ¼ãƒ 
  ```







#### Docker Volumes
ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ä¿å­˜ã—ã¦ãŠã‘ã‚‹é ˜åŸŸ
ãƒ»ã“ã‚Œã¯Containerã‚„Imageã¨ã¯åˆ¥ã§å­˜åœ¨ã—ã¦ã„ã‚‹
ãƒ»èªè¨¼æ©Ÿèƒ½ãªã©ã‚’è©¦ã™éš›ã«ä½œã‚‹ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã©ã‚’ä¿å­˜ã§ãã‚‹
ï¼ˆã‚³ãƒ³ãƒ†ãƒŠã‚’æ¶ˆã—ã¦ã‚‚æ¶ˆãˆãªã„ï¼‰
ï¼ˆä½¿ã„ã™ãã¯PCã®ãƒªã‚½ãƒ¼ã‚¹ã‚’åœ§è¿«ã™ã‚‹ï¼‰




#### Docker Desktop
ãƒ»Dockerã‚’ä½¿ã†ã«ã‚ãŸã£ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ„ãƒ¼ãƒ«
ï¼ˆå€‹äººã§ã®åˆ©ç”¨ã¯ç„¡æ–™ï¼‰





#### Docker Init
ãƒ»Dockerfile ã¨ docker compose.ymlã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã¦ã‚‹
ãƒ»ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§`docker init`ã¨ã‚³ãƒãƒ³ãƒ‰ã‚’ã™ã‚‹ã ã‘ã§å¯¾è©±å‹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹
ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã§ç”Ÿæˆã•ã‚Œã‚‹ã®ã§è‡ªèº«ã§è¨˜è¼‰ã—ã¦ã„ã











<br>
<br>
<br>