---
title: "Dockerについての基礎学習"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Docker]
published: false
---
### 開発環境
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2
- Heroku

### 行いたいこと
- Dockerの基本概念から応用技術まで全体像を理解する


<br>
<br>
<br>




Dockerの基本概念から応用まで全体像を整理し、仕組みを理解するための記事
前編では「コンテナ、イメージ、DockerHubでのイメージ共有」について解説

Dockerとは

Docker社が提供するコンテナ型仮想化技術を実現するプロダクト
従来のホスト型仮想化と異なり、ゲストOSを起動せずにDocker Engine上でコンテナを動作
従来の仮想化より圧倒的に軽量

Dockerのメリット

複数開発者間でのアプリケーション実行環境の共有が容易
軽量な動作と環境ファイル共有を実現
複雑なアーキテクチャでも簡単にどんなマシンにも共有可能

Docker Engineの要素
⓪ Docker Engine

Dockerを利用するための常駐プログラム
Docker for Mac、Docker for Windows等をインストールして利用

① イメージ（Image）

コンテナを起動するのに必要な設定ファイルをまとめたもの
imageからコンテナを起動する
tagでバージョン管理（例：nginx:latest、nginx:1.14-perl）
レイヤー構造で、読み取り専用

② コンテナ

imageから起動されるアプリケーションの実行環境
主要なコマンド操作（create、start、stop、restart、pause、unpause、rm等）
コンテナへの接続方法（attach、exec）

③ Docker Hub（Container Registry）

Dockerイメージを共有するためのサービス
Githubと同様の仕組みで、リポジトリ作成、push、pullが可能
アカウント作成とログインが必要

イメージの作成方法

Docker Hubから他人が作ったイメージを取得（docker pull）
Dockerfileから自作（FROM、RUN、CMDコマンドを使用）
コンテナからイメージを作成（docker commit）※推奨されない

この4つの要素（Docker Engine、Image、コンテナ、Container Registry）が連携してDockerエコシステムを構成しています。












記事の目的

中編では「データマウント（volume）、Docker Network、Docker Compose」について解説
複数コンテナの管理と連携に関する概念を整理

④ Dockerにおけるデータ管理
コンテナレイヤーのデメリット

コンテナ削除時にデータが消える
コンテナ間でデータ共有ができない
ユニオンファイルシステムのため書き込み速度が遅い

データマウント手法（3種類）
volume

ホストマシン上の指定ディレクトリ（/var/lib/docker/volumes）をコンテナにマウント
docker volume createでvolume作成
--mountオプションでマウント
複数コンテナ間でのファイル共有が可能
コンテナごとに編集権限の設定が可能
管理コマンド：ls、inspect、rm

bind mount

ホストマシン上の任意のディレクトリをマウント
ホスト側から直接操作可能
事前設定不要、起動時にオプション指定
マウント元ディレクトリが存在しない場合はエラー
空ディレクトリをマウントするとコンテナデータが消える可能性

tmpfs（テンプfs）

ホストマシンのメモリ領域をコンテナにマウント
ホストやコンテナ終了時にデータが解放される
メモリサイズ制限のオプション設定可能

⑤ Dockerネットワーク
ネットワークの目的

複数コンテナ間での通信を実現
例：APIサーバコンテナとMySQLコンテナの通信

デフォルトネットワーク（3種類）
Bridgeネットワーク

コンテナのデフォルト接続先
IPアドレス指定での通信は可能
コンテナ名での通信は不可（DNS未定義）
-pオプションで外部ポート公開

Hostネットワーク

Docker hostと同じネットワーク設定
ポート公開設定不要で外部アクセス可能

Noneネットワーク

ネットワークインターフェースが無効
他のネットワークから完全切断が必要

独自ネットワーク

docker network createで作成
コンテナ名での通信が可能（組み込みDNS機能）
管理コマンド：ls、inspect、create、connect、disconnect

⑥ Docker Compose
Docker Composeの目的

複数コンテナのDockerアプリケーションを事前定義して実行
複雑なオプション付きコマンドの自動化
環境共有の円滑化

基本的な使用手順

Dockerfileの用意またはDocker Hubのイメージ準備
docker-compose.ymlの定義
docker-compose upでコンテナ群を起動

Docker Compose使用時の利点

単一のymlファイルで複数コンテナの設定を管理
一つのコマンドで複数コンテナを起動・設定
設定ファイル共有による環境の標準化

主要管理コマンド

docker-compose ps：コンテナ一覧表示
docker-compose up：コンテナ起動
docker-compose down：コンテナ・ネットワーク削除
docker-compose run：指定サービス内でコマンド実行
docker-compose stop/start：コンテナ停止・起動

実装例（Django Webアプリ）

Dockerfile：Python環境とDjangoの設定
docker-compose.yml：webサーバとdbサーバの定義
depends_on：コンテナ起動順序の制御
volumes、portsの設定による環境構築

















記事の目的

後編では「Docker Machine、Docker Swarm」について解説
Dockerの運用・管理に関する高度な概念を整理

⑦ Docker Machine
Docker Machineとは

Docker Engineを搭載した仮想マシンの管理をコマンドラインから実行できるツール
仮想化ソフト（Virtual Box等）をドライバーに使用
Docker Engineが動作する仮想マシンを「Dockerホスト」と呼ぶ
ローカルマシン内やリモートサーバでのDockerホスト管理が可能

主要管理コマンド

docker-machine ls：Dockerホスト一覧表示
docker-machine create --driver virtualbox [ホスト名]：Dockerホスト作成
docker-machine start/stop [ホスト名]：起動・停止
docker-machine env [ホスト名]：環境変数一覧表示
eval $(docker-machine env [ホスト名])：Dockerホストをアクティブ化
docker-machine ssh [ホスト名]：SSH接続
docker-machine ip [ホスト名]：IP確認

クラウドサービスへのプロビジョニング

AWS、GCE等へのDockerホスト作成・管理が可能
AWS EC2の例：IAMキー取得→credentials設定→amazonec2ドライバーで作成
リモートDockerホストでのコンテナ実行・管理

⑧ Docker Swarm
Docker Swarmとは

複数台のDockerホストマシン間でコンテナ間通信の設定・管理を自動化
コンテナオーケストレーションエンジンの1つ（他にKubernetes、DC/OS等）
Swarm Modeによるクラスタ管理機能とオーケストレーション機能を提供

基本概念
ノードの種類

workerノード：コンテナを実行する役割
managerノード：コンテナ実行＋他ノード管理の役割
Ingressオーバーレイネットワークで相互接続

必要ポート

TCP 2377：クラスタ管理通信用
TCP/UDP 7946：ノード間通信用
UDP 4789：オーバーレイネットワークトラフィック用

Swarm管理コマンド

docker swarm init --advertise-addr [IP]：Swarmクラスタ作成
docker node ls：ノード一覧表示
docker swarm join-token worker/manager：ノード追加用トークン生成
docker swarm join --token [トークン] [IP]：ノード参加

主要機能
① ServiceとTaskによるコンテナ管理

Service：どのノードでどのイメージからいくつのコンテナを起動するかを定義
Task：Serviceに基づいてコンテナを実行する個別の指示
スケジューリング：CPUやメモリの空きリソースに従ってタスクを自動分配

ノードのAvailability状態

Active：タスク割り当て可能
Pause：新規タスク割り当て不可、既存タスクは継続
Drain：全タスク割り当て不可、既存タスクも終了

実行モード

レプリカモード：指定したレプリカ数でタスク実行（デフォルト）
グローバルモード：全ノードで1つずつタスク実行

Service管理コマンド

docker service create --name [サービス名] --replicas [数] [イメージ]：サービス作成
docker service ls：サービス一覧
docker service inspect [サービス名]：サービス詳細
docker service update：サービス設定変更
docker service scale [サービス名]=[レプリカ数]：スケール変更
docker service remove [サービス名]：サービス削除

② ローリングアップデート

サービスのタスクを遅延時間を設定して1つずつ更新
--update-delayフラグで更新間隔を設定
実行中コンテナを残しながら順次アップデート

③ Service scale / Resource management / Auto Scaling

システム負荷に応じたコンテナ数の動的調整
オートスケール設定が可能
マシンリソース不足時はインスタンス追加も可能

④ Auto Healing

ノードダウン時に他マシンが自動的にコンテナを補完
複数managerノード設定で冗長性確保

Docker ComposeによるService作成

docker-compose.ymlでサービス定義
deployセクションでSwarm設定（replicas、placement等）
docker stack deploy --compose-file [ファイル] [スタック名]でサービス群を作成

Stack管理コマンド

docker stack deploy --compose-file [ファイル] [スタック名]：スタック作成
docker stack ls：スタック一覧
docker stack remove [スタック名]：スタック削除

この後編では、Dockerの本格的な本番運用に必要な仮想マシン管理とクラスタ管理の仕組みが詳しく説明されており、スケーラブルなシステム構築のための重要な概念が網羅されています。

<br>
<br>


### 以上です。

<br>
<br>
<br>