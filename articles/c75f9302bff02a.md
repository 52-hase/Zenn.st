---
title: "Ruby on Railsã®ã‚¢ãƒ—ãƒªã«LINEã‚’çµ„ã¿è¾¼ã‚€"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [LINE]
published: false
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3


# LINEãƒ­ã‚°ã‚¤ãƒ³ã¨ã¯
ãƒ»LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ãŸã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
ãƒ»è‡ªèº«ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ãŸã«IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒãªã„


# LINE Developersã®ç™»éŒ²

https://developers.line.biz/console/

1. LINE Developers Console ã§æº–å‚™
LINE ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ£ãƒãƒ«ã‚’ä½œæˆ

ãƒãƒ£ãƒãƒ«ä½œæˆ
`Channel ID` ã¨ `Channel Secret` ã‚’æ§ãˆã‚‹

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã—ãŸã„å ´åˆ â†’ æ¨©é™ã‚’ ON

`Callback URL` ã‚’è¨­å®š
https://<your-domain>/users/auth/line/callback


é–‹ç™ºç’°å¢ƒã¯ ngrok ã® URL ã‚’ä½¿ã†ã€‚

2. gem ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# Gemfile
gem 'omniauth-oauth2'
gem 'omniauth-rails_csrf_protection'
gem 'dotenv-rails'

bundle install

3. OmniAuth ã® LINE Strategy ã‚’ä½œã‚‹ï¼ˆè‡ªä½œï¼‰
`app/lib/strategies/line.rb` ã‚’ä½œæˆã™ã‚‹ã€‚
ï¼ˆomniauth-line ãŒå¤ã™ãã‚‹ãŸã‚ã€OAuth2 Strategy ã‚’ç¶™æ‰¿ã—ã¦è‡ªä½œã™ã‚‹æ–¹å¼ï¼‰

4. Devise ã« strategy ã‚’ç™»éŒ²
â— `config/initializers/devise.rb`
require 'strategies/line'

config.omniauth :line,
  ENV['LINE_CHANNEL_ID'],
  ENV['LINE_CHANNEL_SECRET']

â— User ãƒ¢ãƒ‡ãƒ«ã§ OmniAuth ã‚’æœ‰åŠ¹ã«ã™ã‚‹
devise :omniauthable, omniauth_providers: [:line]

validates :uid, uniqueness: { scope: :provider }, if: -> { provider.present? }

5. users ãƒ†ãƒ¼ãƒ–ãƒ«ã« provider, uid ã‚’è¿½åŠ 
rails g migration AddOmniauthToUsers provider:string uid:string
rails db:migrate

6. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° & ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©
â— routes.rb
devise_for :users, controllers: {
  omniauth_callbacks: "users/omniauth_callbacks"
}

â— ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©

`app/controllers/users/omniauth_callbacks_controller.rb`

ãƒ»LINE ã‹ã‚‰è¿”ã£ã¦ããŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å—ã‘å–ã‚‹
ãƒ»User.from_omniauth ã«å‡¦ç†ã‚’æ¸¡ã™
ãƒ»æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã€æ–°è¦ãªã‚‰ä½œæˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³

7. User.from_omniauth ã‚’å®Ÿè£…
ãƒ»auth.info.email, auth.uid, auth.provider ã‚’ä½¿ã£ã¦
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ or æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã€‚

8. view ã« LINE ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
/users/auth/line
ã«ãƒªãƒ³ã‚¯ã™ã‚‹ã ã‘ã§ OKã€‚