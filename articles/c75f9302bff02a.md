---
title: "Ruby on Railsã®ã‚¢ãƒ—ãƒªã«LINEã‚’çµ„ã¿è¾¼ã‚€"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [LINE]
published: false
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3


# LINEãƒ­ã‚°ã‚¤ãƒ³ã¨ã¯
ãƒ»LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ãŸã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
ãƒ»è‡ªèº«ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ãŸã«IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒãªã„


# LINE Developersã®ç™»éŒ²

ãƒ»LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®æ¦‚è¦
https://developers.line.biz/ja/docs/line-developers-console/overview/

ãƒ»ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ç™»éŒ²ã™ã‚‹
https://developers.line.biz/console/

1. LINE Developers Console 
ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç™»éŒ²â†’æŒ‡å®šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã™ã‚‹

[![Image from Gyazo](https://i.gyazo.com/3fed27515776417c7393cbc04ba46524.png)](https://gyazo.com/3fed27515776417c7393cbc04ba46524)
ãƒ»ç™»éŒ²

ãƒãƒ£ãƒãƒ«ä½œæˆ
`Channel ID` ã¨ `Channel Secret` ã‚’æ§ãˆã‚‹

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã—ãŸã„å ´åˆ â†’ æ¨©é™ã‚’ ON

`Callback URL` ã‚’è¨­å®š
https://<your-domain>/users/auth/line/callback








# Rails ã§ LINE ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè£…ã™ã‚‹æ‰‹é †

ã“ã®è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®æµã‚Œã«æ²¿ã£ã¦å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚

1. LINEãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ£ãƒãƒ«ã‚’ä½œæˆ
2. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©å®Ÿè£…
3. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
4. ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè£…ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼‰
5. HTTPS åŒ–ï¼ˆngrokï¼‰
6. LINE Developers è¨­å®š
7. å‹•ä½œç¢ºèª

## å‰æ

- Railsï¼ˆ7ç³»æƒ³å®šï¼‰
- HTTP é€šä¿¡ã« typhoeus ã‚’ä½¿ç”¨
- ç°¡æ˜“ãƒ­ã‚°ã‚¤ãƒ³ã¨ã—ã¦ session[:user_id] ã‚’ä½¿ç”¨

## 1. LINEãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ£ãƒãƒ«ã®ä½œæˆ

1. LINE Developers ã«ã‚¢ã‚¯ã‚»ã‚¹  
   https://developers.line.biz/ja/

2. ã€Œãƒ—ãƒ­ãƒã‚¤ãƒ€ã€â†’ã€ŒLINEãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ£ãƒãƒ«ã€ã‚’ä½œæˆ

3. ãƒãƒ£ãƒãƒ«ID ã¨ ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ã‚’ãƒ¡ãƒ¢  
   ï¼ˆRails ã§ã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆï¼‰

4. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã¯å¾Œã»ã©è¨­å®šï¼ˆngrok å¿…é ˆï¼‰

## 2. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ä½œæˆ
```bash
$ bundle exec rails g controller LineLoginApi
```

## 3. LineLoginApi ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©å®Ÿè£…

ä»¥ä¸‹4ã¤ã®æ©Ÿèƒ½ã‚’æŒãŸã›ã¾ã™ï¼š

- **login**: LINEã®èªå¯ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
- **callback**: èªå¯ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’è¡Œã†
- **get_line_user_id_token**: èªå¯ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆIDãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã‚’å–å¾—
- **get_line_user_id**: IDãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆsubï¼‰ã‚’å–å¾—

### app/controllers/line_login_api_controller.rb
```ruby
class LineLoginApiController < ApplicationController
  require 'json'
  require 'typhoeus'
  require 'securerandom'

  def login
    # CSRFå¯¾ç­–
    session[:state] = SecureRandom.urlsafe_base64

    base_authorization_url = 'https://access.line.me/oauth2/v2.1/authorize'
    response_type = 'code'

    client_id = ENV['LINE_LOGIN_CLIENT_ID'] # ç’°å¢ƒå¤‰æ•°æ¨å¥¨
    redirect_uri = CGI.escape(line_login_api_callback_url)
    state = session[:state]
    scope = 'profile%20openid'

    authorization_url = "#{base_authorization_url}?response_type=#{response_type}&client_id=#{client_id}&redirect_uri=#{redirect_uri}&state=#{state}&scope=#{scope}"

    redirect_to authorization_url, allow_other_host: true
  end

  def callback
    if params[:state] == session[:state]
      line_user_id = get_line_user_id(params[:code])
      user = User.find_or_initialize_by(line_user_id: line_user_id)

      if user.save
        session[:user_id] = user.id
        redirect_to after_login_path, notice: 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ'
      else
        redirect_to root_path, notice: 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ'
      end
    else
      redirect_to root_path, notice: 'ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã™'
    end
  end

  private

  def get_line_user_id(code)
    id_token = get_line_user_id_token(code)
    return nil if id_token.blank?

    url = 'https://api.line.me/oauth2/v2.1/verify'
    options = {
      body: {
        id_token: id_token,
        client_id: ENV['LINE_LOGIN_CLIENT_ID']
      }
    }

    response = Typhoeus::Request.post(url, options)
    return nil unless response.code == 200

    JSON.parse(response.body)['sub']
  end

  def get_line_user_id_token(code)
    url = 'https://api.line.me/oauth2/v2.1/token'
    redirect_uri = line_login_api_callback_url

    options = {
      headers: { 'Content-Type' => 'application/x-www-form-urlencoded' },
      body: {
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: redirect_uri,
        client_id: ENV['LINE_LOGIN_CLIENT_ID'],
        client_secret: ENV['LINE_LOGIN_CLIENT_SECRET']
      }
    }

    response = Typhoeus::Request.post(url, options)
    return nil unless response.code == 200

    JSON.parse(response.body)['id_token']
  end
end
```

## 4. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
```ruby
# config/routes.rb
Rails.application.routes.draw do
  get 'line_login_api/login',    to: 'line_login_api#login'
  get 'line_login_api/callback', to: 'line_login_api#callback'
end
```

## 5. typhoeus ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```ruby
# Gemfile
gem 'typhoeus'
```
```bash
$ bundle install
```

## 6. ãƒ“ãƒ¥ãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
```erb
<!-- app/views/static_pages/before_login.html.erb -->
<div>
  <%= link_to "LINEã§ãƒ­ã‚°ã‚¤ãƒ³", line_login_api_login_path,
      class: "rounded-lg py-3 px-5 bg-green-500 text-white inline-block font-medium" %>
</div>
```

## 7. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒšãƒ¼ã‚¸ã§IDç¢ºèªï¼ˆä»»æ„ï¼‰
```erb
<!-- app/views/static_pages/after_login.html.erb -->
<div>
  <% current_user = User.find(session[:user_id]) %>
  <%= "ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼š#{current_user.id}" %>
</div>
```

## 8. ngrok ã‚’ä½¿ã£ã¦ HTTPS åŒ–ã™ã‚‹

LINEãƒ­ã‚°ã‚¤ãƒ³ã¯ http ã§ã¯å‹•ä½œã—ãªã„ãŸã‚ã€ngrok ã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ« Rails ã‚’ https å…¬é–‹ã—ã¾ã™ã€‚

### ngrok ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
$ unzip ~/Downloads/ngrok-v3-stable-darwin-amd64.zip
$ ./ngrok config add-authtoken <your-token>
```

### ngrok ã®èµ·å‹•
```bash
$ ./ngrok http 3000
```

ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãª URL ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
```
https://xxxxx.jp.ngrok.io
```

## 9. Rails ã«ãƒ›ã‚¹ãƒˆã‚’è¨±å¯ã™ã‚‹
```ruby
# config/environments/development.rb
config.hosts << '.jp.ngrok.io'
```

## 10. LINE Developers ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã‚’ç™»éŒ²
```
https://xxxxx.jp.ngrok.io/line_login_api/callback
```

## 11. å‹•ä½œç¢ºèª

1. ngrok ã‚’èµ·å‹•ã—ãŸã¾ã¾ Rails ã‚’ `./bin/dev` ã§èµ·å‹•
2. `https://xxxxx.jp.ngrok.io` ã«ã‚¢ã‚¯ã‚»ã‚¹
3. ã€ŒLINEã§ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’æŠ¼ã™
4. LINE ã®èªè¨¼ç”»é¢ãŒå‡ºã‚‹
5. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Œã°æˆåŠŸï¼
