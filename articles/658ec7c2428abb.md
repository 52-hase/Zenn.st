---
title: "Spotify APIã‚’ä½¿ã„æ›²ã®å†ç”Ÿæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Spotify]
published: false
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### è¡Œã„ãŸã„ã“ã¨
- Spotify APIã‚’ä½¿ã„ã€€æ›²ã®å†ç”Ÿæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹


<br>
<br>
<br>

# Spotify APIã‚’åˆ©ç”¨ã™ã‚‹ã«ã‚ãŸã£ã¦...
ãƒ»Spotifyã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
ãƒ»Dashboardã‹ã‚‰`ã‚¢ãƒ—ãƒªã®ç™»éŒ²`ã¨`CLIENT ID`ã¨`CLIENT SECRET ID`ã®å–å¾—ã‚’ã™ã‚‹ã€‚
ãƒ»å–å¾—ã—ãŸIDã‚’`ç’°å¢ƒå¤‰æ•°`ã¨ã—ã¦`.envãƒ•ã‚¡ã‚¤ãƒ«`ã«è¨˜è¼‰ã™ã‚‹ã€‚

ã“ã¡ã‚‰ã®æ‰‹é †ã§è¡Œã„ã¾ã—ãŸã€‚
https://zenn.dev/tteaoocl/articles/6cce2e7615c11c

# Gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
ãƒ»ä»¥ä¸‹ã‚’è¿½è¨˜ã—`bundle install`
```ruby:Gemfile
gem 'rspotify'
```

# ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã€è¨˜è¼‰ã™ã‚‹
ãƒ»æ›²ã®è¡¨ç¤ºæ–¹æ³•ã¯ã€`é–‹å‚¬ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§`â‡¨`å‚åŠ ã—ãŸã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¸€è¦§`â‡¨`æŠ«éœ²ã—ãŸæ›²ä¸€è¦§`ã®ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€
  `live_event`, `artist`, `music`, `live_events_artist`ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚


    ```ruby:models/artist.rb
    class Artist < ApplicationRecord
      has_many :live_events_artists
      has_many :live_events, through: :live_events_artists
      has_many :musics, dependent: :destroy
    end
    ```

    ```ruby:models/live_event.rb
    class LiveEvent < ApplicationRecord
      has_many :live_events_artists
      has_many :artists, through: :live_events_artists
      has_many :musics
      validates :name, presence: true
      validates :date, presence: true
    end
    ```

    ```ruby:models/live_events_artist.rb
    class LiveEventsArtist < ApplicationRecord
      belongs_to :live_event
      belongs_to :artist
    end
    ```

    ```ruby:models/music.rb
    class Music < ApplicationRecord
      belongs_to :artist
      belongs_to :live_event
    end
    ```



# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’è¨˜è¼‰ã™ã‚‹
    ```ruby:live_events_controller.rb
    class LiveEventsController < ApplicationController
      def index
        @live_events = LiveEvent.all
      end
    
      def show
        @live_event = LiveEvent.find(params[:id])
      end
    end
    ```

    ```ruby:musics_controller.rb
    class MusicsController < ApplicationController
      # ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å–å¾—ã€ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å–å¾—
      def index
        @artist = Artist.find(params[:artist_id])
        @live_event = LiveEvent.find(params[:live_event_id]) if params[:live_event_id].present?
        
        # ç‰¹å®šã®ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢é€£ã™ã‚‹æ›²ã®ã¿ã‚’å–å¾—ã€ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®å…¨ã¦ã®æ›²ã‚’å–å¾—
        if @live_event
          @musics = @artist.musics.where(live_event_id: @live_event.id)
        else
          @musics = @artist.musics
        end
        
        # æ›²ã®æƒ…å ±ã‚’æ•´å½¢
        @musics = @musics.map do |music|
          {
            name: music.name,
            artist: music.artist_name,
            id: music.spotify_track_id,
            live_event_id: music.live_event_id
          }
        end
      end
      
      # ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å–å¾—ã€Spotify track IDã§æ›²ã‚’æ¤œç´¢
      def show
        @artist = Artist.find(params[:artist_id])
        @music = Music.find_by(spotify_track_id: params[:id])
      end
    end
    ```

# viewãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰ã™ã‚‹

```ruby:views/musics/index.html.erb
<div class="container">
<div class="row justify-content-center">
    <div class="col-md-3 text-white text-center">
    <h4><%= @artist.name %></h4>
      <!-- @musicsãŒå­˜åœ¨ã—ã€ã‹ã¤ä¸­ã«éŸ³æ¥½ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®å‡¦ç† -->
      <% if @musics && @musics.any? %>
        <div class="list-group">
          <% @musics.each_with_index do |music, index| %>
            <!-- å„éŸ³æ¥½ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒªã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ -->
            <div class="list-group-item d-flex justify-content-between align-items-center mb-3 shadow-sm rounded" style="background-color: rgba(248, 249, 250, 0.4);">
              <div class="d-flex align-items-center flex-grow-1">
                <!-- æ›²ã®ç•ªå·ã¨åå‰å…¨ä½“ã‚’ãƒªãƒ³ã‚¯ã«ã—ã¾ã™ -->
                <%= link_to artist_music_path(@artist, music[:id]), class: 'text-decoration-none text-dark d-flex align-items-center w-100' do %>
                  <h5 class="mb-0 me-3 flex-grow-1">
                    <%= "#{index + 1}. #{music[:name]}" %>
                  </h5>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- éŸ³æ¥½ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="alert alert-warning" role="alert">
          éŸ³æ¥½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
        </div>
      <% end %>
    </div>
  </div>
</div>
```

```ruby:views/musics/show.html.erb
<div class="container">
  <div class="row justify-content-center align-items-center vh-100">
      <!-- Spotify åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
      <iframe src="https://open.spotify.com/embed/track/<%= @music.spotify_track_id %>"
              width="300"
              height="380"
              frameborder="0"
              allowtransparency="true"
              allow="encrypted-media"
      </iframe>
  </div>
</div>
```



# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
ãƒ»db/migrate/20240730065005_create_musics.rb
```
$ rails generate migration CreateMusics name:string artist_name:string
```


# config/initializers/rspotify.rb
```
require 'rspotify'
RSpotify.authenticate(ENV['SPOTIFY_CLIENT_ID'], ENV['SPOTIFY_SECRET_ID'])
```
# app/controllers/musics_controller.rb

::::details 

'''


'''

::::

<br>
<br>
<br>