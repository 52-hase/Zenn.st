---
title: "Spotify APIを使い曲の再生機能を実装する"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Spotify]
published: false
---
### 開発環境
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### 行いたいこと
- Spotify APIを使い　曲の再生機能を実装する


<br>
<br>
<br>

# Spotify APIを利用するにあたって...
・Spotifyのアカウントを作成する。
・Dashboardから`アプリの登録`と`CLIENT ID`と`CLIENT SECRET ID`の取得をする。
・取得したIDを`環境変数`として`.envファイル`に記載する。

こちらの手順で行いました。
https://zenn.dev/tteaoocl/articles/6cce2e7615c11c

# Gem をインストールする
・以下を追記し`bundle install`
```ruby:Gemfile
gem 'rspotify'
```

# モデルを追加、記載する
・曲の表示方法は、`開催されたライブイベント一覧`⇨`参加したアーティスト一覧`⇨`披露した曲一覧`のようにするため、
  `live_event`, `artist`, `music`, `live_events_artist`モデルを追加する。


    ```ruby:models/artist.rb
    class Artist < ApplicationRecord
      has_many :live_events_artists
      has_many :live_events, through: :live_events_artists
      has_many :musics, dependent: :destroy
    end
    ```

    ```ruby:models/live_event.rb
    class LiveEvent < ApplicationRecord
      has_many :live_events_artists
      has_many :artists, through: :live_events_artists
      has_many :musics
      validates :name, presence: true
      validates :date, presence: true
    end
    ```

    ```ruby:models/live_events_artist.rb
    class LiveEventsArtist < ApplicationRecord
      belongs_to :live_event
      belongs_to :artist
    end
    ```

    ```ruby:models/music.rb
    class Music < ApplicationRecord
      belongs_to :artist
      belongs_to :live_event
    end
    ```



# コントローラーを記載する
    ```ruby:live_events_controller.rb
    class LiveEventsController < ApplicationController
      def index
        @live_events = LiveEvent.all
      end
    
      def show
        @live_event = LiveEvent.find(params[:id])
      end
    end
    ```

    ```ruby:musics_controller.rb
    class MusicsController < ApplicationController
      # アーティストを取得、ライブイベントが指定されている場合は取得
      def index
        @artist = Artist.find(params[:artist_id])
        @live_event = LiveEvent.find(params[:live_event_id]) if params[:live_event_id].present?
        
        # 特定のライブイベントに関連する曲のみを取得、ライブイベントが指定されていない場合は、アーティストの全ての曲を取得
        if @live_event
          @musics = @artist.musics.where(live_event_id: @live_event.id)
        else
          @musics = @artist.musics
        end
        
        # 曲の情報を整形
        @musics = @musics.map do |music|
          {
            name: music.name,
            artist: music.artist_name,
            id: music.spotify_track_id,
            live_event_id: music.live_event_id
          }
        end
      end
      
      # アーティストを取得、Spotify track IDで曲を検索
      def show
        @artist = Artist.find(params[:artist_id])
        @music = Music.find_by(spotify_track_id: params[:id])
      end
    end
    ```

# viewファイルを記載する

```ruby:views/musics/index.html.erb
<div class="container">
<div class="row justify-content-center">
    <div class="col-md-3 text-white text-center">
    <h4><%= @artist.name %></h4>
      <!-- @musicsが存在し、かつ中に音楽が含まれている場合の処理 -->
      <% if @musics && @musics.any? %>
        <div class="list-group">
          <% @musics.each_with_index do |music, index| %>
            <!-- 各音楽アイテムをリストグループアイテムとして表示します -->
            <div class="list-group-item d-flex justify-content-between align-items-center mb-3 shadow-sm rounded" style="background-color: rgba(248, 249, 250, 0.4);">
              <div class="d-flex align-items-center flex-grow-1">
                <!-- 曲の番号と名前全体をリンクにします -->
                <%= link_to artist_music_path(@artist, music[:id]), class: 'text-decoration-none text-dark d-flex align-items-center w-100' do %>
                  <h5 class="mb-0 me-3 flex-grow-1">
                    <%= "#{index + 1}. #{music[:name]}" %>
                  </h5>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- 音楽が見つからなかった場合の警告メッセージ -->
        <div class="alert alert-warning" role="alert">
          音楽が見つかりませんでした。
        </div>
      <% end %>
    </div>
  </div>
</div>
```

```ruby:views/musics/show.html.erb
<div class="container">
  <div class="row justify-content-center align-items-center vh-100">
      <!-- Spotify 埋め込みプレイヤー -->
      <iframe src="https://open.spotify.com/embed/track/<%= @music.spotify_track_id %>"
              width="300"
              height="380"
              frameborder="0"
              allowtransparency="true"
              allow="encrypted-media"
      </iframe>
  </div>
</div>
```



# マイグレージョンファイルの作成
・db/migrate/20240730065005_create_musics.rb
```
$ rails generate migration CreateMusics name:string artist_name:string
```


# config/initializers/rspotify.rb
```
require 'rspotify'
RSpotify.authenticate(ENV['SPOTIFY_CLIENT_ID'], ENV['SPOTIFY_SECRET_ID'])
```
# app/controllers/musics_controller.rb

::::details 

'''


'''

::::

<br>
<br>
<br>