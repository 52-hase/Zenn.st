---
title: "Spotify APIã‚’ä½¿ã„æ›²ã®å†ç”Ÿæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Spotify]
published: false
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### è¡Œã„ãŸã„ã“ã¨
- Spotify APIã‚’ä½¿ã„ã€€æ›²ã®å†ç”Ÿæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹


<br>
<br>
<br>

# Spotify APIã‚’åˆ©ç”¨ã™ã‚‹ã«ã‚ãŸã£ã¦...
ãƒ»Spotifyã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
ãƒ»Dashboardã‹ã‚‰`ã‚¢ãƒ—ãƒªã®ç™»éŒ²`ã¨`CLIENT ID`ã¨`CLIENT SECRET ID`ã®å–å¾—ã‚’ã™ã‚‹ã€‚
ãƒ»å–å¾—ã—ãŸIDã‚’`ç’°å¢ƒå¤‰æ•°`ã¨ã—ã¦`.envãƒ•ã‚¡ã‚¤ãƒ«`ã«è¨˜è¼‰ã™ã‚‹ã€‚

ã“ã¡ã‚‰ã®æ‰‹é †ã§è¡Œã„ã¾ã—ãŸã€‚
https://zenn.dev/tteaoocl/articles/6cce2e7615c11c

# Gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
ãƒ»ä»¥ä¸‹ã‚’è¿½è¨˜ã—`bundle install`
```ruby:Gemfile
gem 'rspotify'
```

# ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã€è¨˜è¼‰ã™ã‚‹
ãƒ»æ›²ã®è¡¨ç¤ºæ–¹æ³•ã¯ã€`é–‹å‚¬ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§`â‡¨`å‚åŠ ã—ãŸã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¸€è¦§`â‡¨`æŠ«éœ²ã—ãŸæ›²ä¸€è¦§`ã®ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€
  `live_event`, `artist`, `music`, `live_events_artist`ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚


    ```ruby:models/artist.rb
    class Artist < ApplicationRecord
      has_many :live_events_artists
      has_many :live_events, through: :live_events_artists
      has_many :musics, dependent: :destroy
    end
    ```

    ```ruby:models/live_event.rb
    class LiveEvent < ApplicationRecord
      has_many :live_events_artists
      has_many :artists, through: :live_events_artists
      has_many :musics
      validates :name, presence: true
      validates :date, presence: true
    end
    ```

    ```ruby:models/live_events_artist.rb
    class LiveEventsArtist < ApplicationRecord
      belongs_to :live_event
      belongs_to :artist
    end
    ```

    ```ruby:models/music.rb
    class Music < ApplicationRecord
      belongs_to :artist
      belongs_to :live_event
    end
    ```


# viewãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰ã™ã‚‹



# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’è¨˜è¼‰ã™ã‚‹
    ```ruby:live_events_controller.rb
    class LiveEventsController < ApplicationController
      def index
        @live_events = LiveEvent.all
      end
    
      def show
        @live_event = LiveEvent.find(params[:id])
      end
    end
    ```

    ```ruby:musics_controller.rb
    class MusicsController < ApplicationController
      # ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å–å¾—ã€ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å–å¾—
      def index
        @artist = Artist.find(params[:artist_id])
        @live_event = LiveEvent.find(params[:live_event_id]) if params[:live_event_id].present?
        
        # ç‰¹å®šã®ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢é€£ã™ã‚‹æ›²ã®ã¿ã‚’å–å¾—ã€ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®å…¨ã¦ã®æ›²ã‚’å–å¾—
        if @live_event
          @musics = @artist.musics.where(live_event_id: @live_event.id)
        else
          @musics = @artist.musics
        end
        
        # æ›²ã®æƒ…å ±ã‚’æ•´å½¢
        @musics = @musics.map do |music|
          {
            name: music.name,
            artist: music.artist_name,
            id: music.spotify_track_id,
            live_event_id: music.live_event_id
          }
        end
        
      end
      
      # ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å–å¾—ã€Spotify track IDã§æ›²ã‚’æ¤œç´¢
      def show
        @artist = Artist.find(params[:artist_id])
        @music = Music.find_by(spotify_track_id: params[:id])
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ›²ãŒå­˜åœ¨ã—ãªã„å ´åˆã®å‡¦ç†
        if @music.nil?
          Rails.logger.info "Music not found in database for ID: #{params[:id]}"
          begin
            # Spotify APIã‚’ä½¿ç”¨ã—ã¦æ›²æƒ…å ±ã‚’å–å¾—ã€ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å–å¾—ã€æ–°ã—ã„æ›²ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
            @track = RSpotify::Track.find(params[:id])
            if @track && @track.artists.map(&:name).include?(@artist.name)
              live_event = LiveEvent.find(params[:live_event_id]) if params[:live_event_id]
              @music = Music.new(
                spotify_track_id: @track.id,
                name: @track.name,
                artist_name: @track.artists.first.name,
                artist: @artist,
                live_event: live_event
              )
              
              if @music.save
                Rails.logger.info "Created new music entry: #{@music.inspect}"
              else
                Rails.logger.error "Failed to save music: #{@music.errors.full_messages.join(', ')}"
              end
            else
              Rails.logger.info "Track not found in Spotify for ID: #{params[:id]} or does not match artist"
            end
          rescue => e
            Rails.logger.error "Spotify API error: #{e.message}"
          end
        end
        
        # æ›²ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€showãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã€è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®æ›²ä¸€è¦§ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        if @music
          render :show
        else
          redirect_to artist_musics_path(@artist), alert: "Music with ID #{params[:id]} not found"
        end
      end
      
      private
      
    end
    ```


# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
ãƒ»db/migrate/20240730065005_create_musics.rb
```
$ rails generate migration CreateMusics name:string artist_name:string
```


# config/initializers/rspotify.rb
```
require 'rspotify'
RSpotify.authenticate(ENV['SPOTIFY_CLIENT_ID'], ENV['SPOTIFY_SECRET_ID'])
```
# app/controllers/musics_controller.rb

::::details 

'''


'''

::::

<br>
<br>
<br>