---
title: "Active Storageの画像をAWSのS3へ保存する"
emoji: "🖼️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [ActiveStorage, AWS, S3]
published: true
---
### 開発環境
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### 行いたいこと
- Herokuのデプロイ環境では、アプリケーションのファイルシステムは`揮発性ストレージ`を使用しています。そのため、デプロイやアプリケーションの再起動時にファイルシステムの変更が失われてしまいます。
- 今回は画像のデータを永続的に保存するために、`AWS`の`S3`を導入したのでその流れを記載します。

### 前提として
- 既にActive Storageの画像を正しく保存できている
- AWSのアカウントは作成済み
- Herokuにはデプロイ済み


# AWSのS3でバケットを作成する

##### リージョンを`東京`に変更する。（デフォルトは`バージニア北部`となっている）
details 参考画像
[![Image from Gyazo](https://i.gyazo.com/903dba2e4bb9d7a85f75973dec9b6ab9.png =300x)](https://gyazo.com/903dba2e4bb9d7a85f75973dec9b6ab9)


##### 検索欄に`S3`と入力し`S3`を選択する。
details 参考画像
[![Image from Gyazo](https://i.gyazo.com/9268e288928375881727816b2eb56949.png)](https://gyazo.com/9268e288928375881727816b2eb56949)


##### バケットを作成する。
details 参考画像
[![Image from Gyazo](https://i.gyazo.com/35166ce7b979b1fdd606581eac34037b.png)](https://gyazo.com/35166ce7b979b1fdd606581eac34037b)


##### バケットの一般的な設定（この設定以外はデフォルト）
details バケット名の記載
・任意の`バケット名`を記載する。
[![Image from Gyazo](https://i.gyazo.com/62510113652b4be7facea27902ca4ca2.png)](https://gyazo.com/62510113652b4be7facea27902ca4ca2)


details バケットのブロックパブリックアクセス設定
・`パブリックアクセスをすべてブロック`のチェックを外す。
・画像のように下の２つにチェックを入れる。 ⇨ 表示される`承認します`にチェックを入れる。
・`バケットを作成`を選択
[![Image from Gyazo](https://i.gyazo.com/bb74ab2ccd097e8653696ad2feb77158.png =600x)](https://gyazo.com/bb74ab2ccd097e8653696ad2feb77158)


# IAMポリシーの作成
##### 検索欄で`IAM`と入力し`IAM`を選択する。 ⇨ `ポリシー`を選択する。 ⇨ `ポリシー`の作成 
details 参考画像
・`IAM`を選択
[![Image from Gyazo](https://i.gyazo.com/8764d8807374f310c2871f83a6ebe8a2.png)](https://gyazo.com/8764d8807374f310c2871f83a6ebe8a2)
・ポリシーを選択
[![Image from Gyazo](https://i.gyazo.com/63dc3eebd839ce34f58571d19cfebfe5.png =200x)](https://gyazo.com/63dc3eebd839ce34f58571d19cfebfe5)
・ポリシーの作成
[![Image from Gyazo](https://i.gyazo.com/febc5aa717c86877afd72723f66a8202.png)](https://gyazo.com/febc5aa717c86877afd72723f66a8202)


##### アクセス許可を指定 
details サービスを選択でS3を選択
・`S3`を選択 ⇨ 次へ
[![Image from Gyazo](https://i.gyazo.com/5e4e0da01d4acfa03fd7848f3e8b5137.png)](https://gyazo.com/5e4e0da01d4acfa03fd7848f3e8b5137)


details リスト、読み取り、書き込み、許可の管理、タグ付けをそれぞれ選択する
・`S3`タブを展開
[![Image from Gyazo](https://i.gyazo.com/240866e04a79a0f7808f08a6dd17d016.png =400x)](https://gyazo.com/240866e04a79a0f7808f08a6dd17d016)

・リスト ⇨ `ListBucket`
[![Image from Gyazo](https://i.gyazo.com/f740a5c9da323791081058f83808b88c.png)](https://gyazo.com/f740a5c9da323791081058f83808b88c)
・読み取り ⇨ `GetObject`
[![Image from Gyazo](https://i.gyazo.com/9666c63fd34673eb74d6348afabeb0cd.png)](https://gyazo.com/9666c63fd34673eb74d6348afabeb0cd)
・書き込み ⇨ `DeleteObject`と`PutObject`
[![Image from Gyazo](https://i.gyazo.com/72c380078a68018d0dd6aa0dec1ec715.png)](https://gyazo.com/72c380078a68018d0dd6aa0dec1ec715)
・許可の管理 ⇨ `PutObjectAcl`
[![Image from Gyazo](https://i.gyazo.com/9a9fb37c4800c3d6af2dc5d8964fe744.png)](https://gyazo.com/9a9fb37c4800c3d6af2dc5d8964fe744)


details ARNを追加をする
・bucketのみ`ARNを追加`を選択し記載
[![Image from Gyazo](https://i.gyazo.com/7ae04ecde20e8cb78ff4b316d6159829.png)](https://gyazo.com/7ae04ecde20e8cb78ff4b316d6159829)
・リソースバケット名に作成したバケット名を記載する（リソースARNは自動で記載される）⇨ `ARNを追加` ⇨ 次へ
[![Image from Gyazo](https://i.gyazo.com/5f045cde47b7a72b3a7d479c5e4b544f.png)](https://gyazo.com/5f045cde47b7a72b3a7d479c5e4b544f)


##### ポリシーの詳細
details ポリシー名を記載
・ポリシー名のみ記載（説明-オプションは不要）
[![Image from Gyazo](https://i.gyazo.com/5dce4f24180631d31715f89ef4a90bd6.png)](https://gyazo.com/5dce4f24180631d31715f89ef4a90bd6)
・ポリシーの作成
[![Image from Gyazo](https://i.gyazo.com/7fc7aa9a0c8677eab158bc1d0411cef7.png)](https://gyazo.com/7fc7aa9a0c8677eab158bc1d0411cef7)


# IAMユーザーの作成
##### ユーザータブ ⇨ ユーザーの作成
details 参考画像
・ユーザータブ
[![Image from Gyazo](https://i.gyazo.com/7c266df10c6d5fbf428e66415adde700.png =200x)](https://gyazo.com/7c266df10c6d5fbf428e66415adde700)
・ユーザーを作成
[![Image from Gyazo](https://i.gyazo.com/a01df4003b9b0b7333c9012720ab3ec1.png)](https://gyazo.com/a01df4003b9b0b7333c9012720ab3ec1)


##### 許可を設定
details 参考画像
・`ポリシーを直接アタッチする`を選択する ⇨  検索欄で先ほど作成した`IAMポリシー`を検索する
  　⇨ ポリシーを選択 ⇨ `次へ`
[![Image from Gyazo](https://i.gyazo.com/7fb0df81e787b9937874419b81d34585.png)](https://gyazo.com/7fb0df81e787b9937874419b81d34585)
・ユーザーの詳細、許可の概要を確認して ⇨ `ユーザーの作成`
[![Image from Gyazo](https://i.gyazo.com/50439ac722d4f3c3d6de0bfe6c073834.png)](https://gyazo.com/50439ac722d4f3c3d6de0bfe6c073834)



# アクセスキーを作成
##### ユーザータブ ⇨ ユーザー名を選択
details 参考画像
[![Image from Gyazo](https://i.gyazo.com/b16ee53a08dc263494b3060138746709.png =400x)](https://gyazo.com/b16ee53a08dc263494b3060138746709)

##### セキュリティ認証情報タブ ⇨ アクセスキーを作成
details 参考画像
・セキュリティ認証情報タブ
[![Image from Gyazo](https://i.gyazo.com/b8a8b26f7c86b0e16f7d6bc8f455f9b1.png)](https://gyazo.com/b8a8b26f7c86b0e16f7d6bc8f455f9b1)
・アクセスキーを作成
[![Image from Gyazo](https://i.gyazo.com/aa86d8bc0bf3add280d5f6c575eb0d13.png)](https://gyazo.com/aa86d8bc0bf3add280d5f6c575eb0d13)


##### 主要なベストプラクティスと代替案にアクセスするの設定 ⇨ 説明タグを設定-オプション
details 参考画像
・`AWS の外部で実行されるアプリケーション`を選択する ⇨ `次へ`
[![Image from Gyazo](https://i.gyazo.com/48bfe08dab92d02dfb9acd0bf362205d.png)](https://gyazo.com/48bfe08dab92d02dfb9acd0bf362205d)
・`説明タグを設定-オプション`は不要なのでそのまま`アクセスキーを作成`
[![Image from Gyazo](https://i.gyazo.com/12891e0c6dc9ac9c44ae5ea46def93e6.png)](https://gyazo.com/12891e0c6dc9ac9c44ae5ea46def93e6)


# バケットポリシーの設定
##### 作成したバケットへ移動し`アクセス許可タブ`を選択する ⇨ バケットポリシーの`編集`を選択
details 参考画像
・画像のように記載しました。
[![Image from Gyazo](https://i.gyazo.com/81e5ec38876670e8d189de0dbf240c92.png =600x)](https://gyazo.com/81e5ec38876670e8d189de0dbf240c92)
```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "ユーザーページからARNをコピーして貼り付け"
      },
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::バケット名",
        "arn:aws:s3:::バケット名/*"
      ]
    }
  ]
}
```


##### ユーザーページからARNをコピー
details 参考画像
・ユーザータブからユーザー名を選択
[![Image from Gyazo](https://i.gyazo.com/b16ee53a08dc263494b3060138746709.png =400x)](https://gyazo.com/b16ee53a08dc263494b3060138746709)
・こちらをコピー
[![Image from Gyazo](https://i.gyazo.com/3b1567cc6464258972eae45741bc654d.png)](https://gyazo.com/3b1567cc6464258972eae45741bc654d)


# ファイルへの記載

## gem 'aws-sdk-s3'の追加
details Gemfile
・追記
```
gem 'aws-sdk-s3'
```
・インストール
```
$ bundle install
```




## config/credentials.yml.enc への記載（隠しファイル）
##### 記載内容
details ４つを記載していく
`アクセスキー`、`シークレットアクセスキー`、`リージョン`、`バケット名`




##### このファイルはエディターから直接記載ができないので`vim`で記載していく
details EDITOR="vim" rails credentials:edit
・コンテナに入り
```
$ docker-compose exec web bash
```
・ファイルを指定しvimで開く
```
$ EDITOR="vim" rails credentials:edit
```
・このような記載になっていると思うので...
```
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: ・・・・・・・・・・・・・・・・・・・省略・・・・・・・・・・・・・・・・・・・


```
必要事項を追記する（`:`の後のスペースや改行に気をつける）
```
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: ・・・・・・・・・・・・・・・・・・・省略・・・・・・・・・・・・・・・・・・・

aws:
  access_key_id: アクセスキー
  secret_access_key: シークレットアクセスキー
  region: リージョン
  bucket: バケット名
```


##### 保存コードの確認方法
details コンソールから確認（Rails.application.credentials.aws）
・コンソールを開く
```
$ rails c
```
・`Rails.application.credentials.aws`
```
irb(main):001> Rails.application.credentials.aws
=> {:access_key_id=>"アクセスキー", :secret_access_key=>"シークレットアクセスキー", 
    :region=>"リージョン", :bucket=>"バケット名"}
```


details コンテナから確認（rails credentials:show）
・コンテナに入る
```
$ docker-compose exec web bash 
```
・`rails credentials:show`
```
root@b7f741d3e5aa:/myapp# rails credentials:show
```
・ファイルのコードがそのまま表示される
```
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: ・・・・・・・・・・・・・・・・・・・省略・・・・・・・・・・・・・・・・・・・

aws:
  access_key_id: アクセスキー
  secret_access_key: シークレットアクセスキー
  region: リージョン
  bucket: バケット名
```



##### 保存に成功した場合と失敗した場合の表示
details 参考画像
・保存に成功した表示
[![Image from Gyazo](https://i.gyazo.com/f006631decadbae05ed1eecc7f4ae9f2.png)](https://gyazo.com/f006631decadbae05ed1eecc7f4ae9f2)
・保存に失敗した表示（画像はインデントとスペースのエラー）
[![Image from Gyazo](https://i.gyazo.com/e0ada61f07dca84cf6a701da093f7b2f.png)](https://gyazo.com/e0ada61f07dca84cf6a701da093f7b2f)


message alert
保存に失敗した際はそのままDockerを閉じてしまうと、
`エラーでDockerが起動できない`⇨`コンテナに入れない`⇨`入れないのでvimでファイルの修正ができない`
⇨`エラーが解消できない`のループに入ってしまう。

その時は`config/credentials.yml.enc`このファイルを削除して、
もう一度`EDITOR="vim" rails credentials:edit`このコマンドからやり直す。



## config/storage.yml への記載

details 記載方法
・隠しファイル`config/credentials.yml.enc`を正しく参照できるように、
　`インデント`と`改行`に気をつける。

config/storage.yml
```
local:
  service: S3
  access_key_id: <%= ENV['AWS_ACCESS_KEY_ID'] %>
  secret_access_key: <%= ENV['AWS_SECRET_ACCESS_KEY'] %>
  region: <%= ENV['AWS_REGION'] %>
  bucket: <%= ENV['AWS_BUCKET'] %>

amazon:
  service: S3
  access_key_id: <%= ENV['AWS_ACCESS_KEY_ID'] %>
  secret_access_key: <%= ENV['AWS_SECRET_ACCESS_KEY'] %>
  region: <%= ENV['AWS_REGION'] %>
  bucket: <%= ENV['AWS_BUCKET'] %>
```


## config/environments/development.rb への記載

details 追記コード
config.active_storage.service = :amazon


## config/environments/production.rb への記載

details 追記コード
・`development.rbファイル`と同様の追記をする
config.active_storage.service = :amazon


# Herokuに環境変数を記載
##### Herokuのダッシュボードから、`設定`⇨`設定変数　`⇨`鍵`と`価値`に値を入力し`追加`
details 手順
・設定タブ
[![Image from Gyazo](https://i.gyazo.com/914ec4a813e92fe2e3fdebfd27d68212.png)](https://gyazo.com/914ec4a813e92fe2e3fdebfd27d68212)
・`鍵`と`価値`に値を入力し`追加`
[![Image from Gyazo](https://i.gyazo.com/6e65aa2a63db2e789ddfd5d8473d18ae.png)](https://gyazo.com/6e65aa2a63db2e789ddfd5d8473d18ae)
・環境変数を記載（`config/storage.ymlファイル`が参照できるように正しく記載）
[![Image from Gyazo](https://i.gyazo.com/8e476b902b15109233ed4534a1cd7a1a.png)](https://gyazo.com/8e476b902b15109233ed4534a1cd7a1a)

##### ターミナルからHerokuの環境変数を確認する
details heroku config
・Herokuの環境変数を確認
```
$ heroku config
```
・正しく登録されているか確認
```
AWS_ACCESS_KEY_ID:        アクセスキー
AWS_BUCKET:               バケット名
AWS_REGION:               リージョン
AWS_SECRET_ACCESS_KEY:    シークレットアクセスキー
```


# 開発環境にも環境変数を記載する
##### 隠しファイル`.env`に環境変数を記載する
details .env
```
AWS_ACCESS_KEY_ID=アクセスキー
AWS_SECRET_ACCESS_KEY=シークレットアクセスキー
AWS_REGION=リージョン
AWS_BUCKET=バケット名
```

