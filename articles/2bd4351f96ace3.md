---
title: "Active Storageの画像をAWSのS3へ保存する"
emoji: "🖼️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [ActiveStorage, AWS, S3]
published: false
---
### 開発環境
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### 行いたいこと
- Herokuのデプロイ環境では、アプリケーションのファイルシステムは`揮発性ストレージ`を使用しています。そのため、デプロイやアプリケーションの再起動時にファイルシステムの変更が失われてしまいます。
今回は画像のデータを永続的に保存するために、`AWS`の`S3`を導入したのでその流れを記載します。

### 前提として
- 既にActive Storageの画像を正しく保存できている
- AWSのアカウントは作成済み
- Herokuにはデプロイ済み


# AWSのS3でバケットを作成する

##### リージョンを`東京`に変更する。（デフォルトは`バージニア北部`となっている）
::::details 参考画像
[![Image from Gyazo](https://i.gyazo.com/903dba2e4bb9d7a85f75973dec9b6ab9.png)](https://gyazo.com/903dba2e4bb9d7a85f75973dec9b6ab9)
::::

##### 検索欄に`S3`と入力し`S3`を選択する。
::::details 参考画像
[![Image from Gyazo](https://i.gyazo.com/9268e288928375881727816b2eb56949.png)](https://gyazo.com/9268e288928375881727816b2eb56949)
::::

##### バケットを作成する。
::::details 参考画像
[![Image from Gyazo](https://i.gyazo.com/35166ce7b979b1fdd606581eac34037b.png)](https://gyazo.com/35166ce7b979b1fdd606581eac34037b)
::::

##### バケットの一般的な設定（この設定以外はデフォルト）
::::details バケット名の記載
・任意のバケット名を記載する。
[![Image from Gyazo](https://i.gyazo.com/62510113652b4be7facea27902ca4ca2.png)](https://gyazo.com/62510113652b4be7facea27902ca4ca2)
::::

::::details バケットのブロックパブリックアクセス設定
・`パブリックアクセスをすべてブロック`のチェックを外す。
・画像のように下の２つにチェックを入れる。 ⇨ 表示される`承認します`にチェックを入れる。
・`バケットを作成`を選択
[![Image from Gyazo](https://i.gyazo.com/bb74ab2ccd097e8653696ad2feb77158.png)](https://gyazo.com/bb74ab2ccd097e8653696ad2feb77158)
::::

# IAMポリシーの作成
##### 検索欄で`IAM`と入力し`IAM`を選択する。 ⇨ `ポリシー`を選択する。 ⇨ `ポリシー`の作成 
::::details 参考画像
・`IAM`を選択
[![Image from Gyazo](https://i.gyazo.com/8764d8807374f310c2871f83a6ebe8a2.png)](https://gyazo.com/8764d8807374f310c2871f83a6ebe8a2)
・ポリシーを選択
[![Image from Gyazo](https://i.gyazo.com/63dc3eebd839ce34f58571d19cfebfe5.png)](https://gyazo.com/63dc3eebd839ce34f58571d19cfebfe5)
・ポリシーの作成
[![Image from Gyazo](https://i.gyazo.com/febc5aa717c86877afd72723f66a8202.png)](https://gyazo.com/febc5aa717c86877afd72723f66a8202)
::::

##### アクセス許可を指定 
::::details サービスを選択でS3を選択
・`S3`を選択 ⇨ 次へ
[![Image from Gyazo](https://i.gyazo.com/5e4e0da01d4acfa03fd7848f3e8b5137.png)](https://gyazo.com/5e4e0da01d4acfa03fd7848f3e8b5137)
::::

::::details リスト、読み取り、書き込み、許可の管理、タグ付けをそれぞれ選択する
・`S3`タブを展開
[![Image from Gyazo](https://i.gyazo.com/240866e04a79a0f7808f08a6dd17d016.png =400x)](https://gyazo.com/240866e04a79a0f7808f08a6dd17d016)

・リスト ⇨ `ListBucket`
[![Image from Gyazo](https://i.gyazo.com/f740a5c9da323791081058f83808b88c.png)](https://gyazo.com/f740a5c9da323791081058f83808b88c)
・読み取り ⇨ `GetObject`
[![Image from Gyazo](https://i.gyazo.com/9666c63fd34673eb74d6348afabeb0cd.png)](https://gyazo.com/9666c63fd34673eb74d6348afabeb0cd)
・書き込み ⇨ `DeleteObject`と`PutObject`
[![Image from Gyazo](https://i.gyazo.com/72c380078a68018d0dd6aa0dec1ec715.png)](https://gyazo.com/72c380078a68018d0dd6aa0dec1ec715)
・許可の管理 ⇨ `PutObjectAcl`
[![Image from Gyazo](https://i.gyazo.com/9a9fb37c4800c3d6af2dc5d8964fe744.png)](https://gyazo.com/9a9fb37c4800c3d6af2dc5d8964fe744)
::::

::::details ARNを追加をする
・bucketのみ`ARNを追加`を選択し記載
[![Image from Gyazo](https://i.gyazo.com/7ae04ecde20e8cb78ff4b316d6159829.png)](https://gyazo.com/7ae04ecde20e8cb78ff4b316d6159829)
・リソースバケット名に作成したバケット名を記載する（リソースARNは自動で記載される）⇨ `ARNを追加` ⇨ 次へ
[![Image from Gyazo](https://i.gyazo.com/5f045cde47b7a72b3a7d479c5e4b544f.png)](https://gyazo.com/5f045cde47b7a72b3a7d479c5e4b544f)
::::

##### ポリシーの詳細
::::details ポリシー名を記載
・ポリシー名のみ記載（説明-オプションは不要）
[![Image from Gyazo](https://i.gyazo.com/5dce4f24180631d31715f89ef4a90bd6.png)](https://gyazo.com/5dce4f24180631d31715f89ef4a90bd6)
・ポリシーの作成
[![Image from Gyazo](https://i.gyazo.com/7fc7aa9a0c8677eab158bc1d0411cef7.png)](https://gyazo.com/7fc7aa9a0c8677eab158bc1d0411cef7)
::::

# IAMユーザーの作成

::::details 
[![Image from Gyazo](https://i.gyazo.com/7c266df10c6d5fbf428e66415adde700.png)](https://gyazo.com/7c266df10c6d5fbf428e66415adde700)
::::

::::details 

'''


'''

::::

::::details 

'''


'''

::::

::::details 

'''


'''

::::

::::details 

'''


'''

::::


::::details 

'''


'''

::::

::::details 

'''


'''

::::



::::details 

'''


'''

::::

::::details 

'''


'''

::::



::::details 

'''


'''

::::

::::details 

'''


'''

::::