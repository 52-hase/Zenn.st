---
title: "Active Storageã®ç”»åƒã‚’AWSã®S3ã¸ä¿å­˜ã™ã‚‹"
emoji: "ğŸ–¼ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ActiveStorage, AWS, S3]
published: true
---
### é–‹ç™ºç’°å¢ƒ
- macOS
- VSCode
- Rails 7.1.3.3
- ruby-3.2.3
- PostgreSQL 16.2

### è¡Œã„ãŸã„ã“ã¨
- Herokuã®ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¯`æ®ç™ºæ€§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å¤‰æ›´ãŒå¤±ã‚ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
- ä»Šå›ã¯ç”»åƒã®ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šçš„ã«ä¿å­˜ã™ã‚‹ãŸã‚ã«ã€`AWS`ã®`S3`ã‚’å°å…¥ã—ãŸã®ã§ãã®æµã‚Œã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

### å‰æã¨ã—ã¦
- æ—¢ã«Active Storageã®ç”»åƒã‚’æ­£ã—ãä¿å­˜ã§ãã¦ã„ã‚‹
- AWSã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä½œæˆæ¸ˆã¿
- Herokuã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿


# AWSã®S3ã§ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹

##### ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’`æ±äº¬`ã«å¤‰æ›´ã™ã‚‹ã€‚ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`ãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨`ã¨ãªã£ã¦ã„ã‚‹ï¼‰
details å‚è€ƒç”»åƒ
[![Image from Gyazo](https://i.gyazo.com/903dba2e4bb9d7a85f75973dec9b6ab9.png =300x)](https://gyazo.com/903dba2e4bb9d7a85f75973dec9b6ab9)


##### æ¤œç´¢æ¬„ã«`S3`ã¨å…¥åŠ›ã—`S3`ã‚’é¸æŠã™ã‚‹ã€‚
details å‚è€ƒç”»åƒ
[![Image from Gyazo](https://i.gyazo.com/9268e288928375881727816b2eb56949.png)](https://gyazo.com/9268e288928375881727816b2eb56949)


##### ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
details å‚è€ƒç”»åƒ
[![Image from Gyazo](https://i.gyazo.com/35166ce7b979b1fdd606581eac34037b.png)](https://gyazo.com/35166ce7b979b1fdd606581eac34037b)


##### ãƒã‚±ãƒƒãƒˆã®ä¸€èˆ¬çš„ãªè¨­å®šï¼ˆã“ã®è¨­å®šä»¥å¤–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
details ãƒã‚±ãƒƒãƒˆåã®è¨˜è¼‰
ãƒ»ä»»æ„ã®`ãƒã‚±ãƒƒãƒˆå`ã‚’è¨˜è¼‰ã™ã‚‹ã€‚
[![Image from Gyazo](https://i.gyazo.com/62510113652b4be7facea27902ca4ca2.png)](https://gyazo.com/62510113652b4be7facea27902ca4ca2)


details ãƒã‚±ãƒƒãƒˆã®ãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š
ãƒ»`ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯`ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã€‚
ãƒ»ç”»åƒã®ã‚ˆã†ã«ä¸‹ã®ï¼’ã¤ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã€‚ â‡¨ è¡¨ç¤ºã•ã‚Œã‚‹`æ‰¿èªã—ã¾ã™`ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã€‚
ãƒ»`ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ`ã‚’é¸æŠ
[![Image from Gyazo](https://i.gyazo.com/bb74ab2ccd097e8653696ad2feb77158.png =600x)](https://gyazo.com/bb74ab2ccd097e8653696ad2feb77158)


# IAMãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
##### æ¤œç´¢æ¬„ã§`IAM`ã¨å…¥åŠ›ã—`IAM`ã‚’é¸æŠã™ã‚‹ã€‚ â‡¨ `ãƒãƒªã‚·ãƒ¼`ã‚’é¸æŠã™ã‚‹ã€‚ â‡¨ `ãƒãƒªã‚·ãƒ¼`ã®ä½œæˆ 
details å‚è€ƒç”»åƒ
ãƒ»`IAM`ã‚’é¸æŠ
[![Image from Gyazo](https://i.gyazo.com/8764d8807374f310c2871f83a6ebe8a2.png)](https://gyazo.com/8764d8807374f310c2871f83a6ebe8a2)
ãƒ»ãƒãƒªã‚·ãƒ¼ã‚’é¸æŠ
[![Image from Gyazo](https://i.gyazo.com/63dc3eebd839ce34f58571d19cfebfe5.png =200x)](https://gyazo.com/63dc3eebd839ce34f58571d19cfebfe5)
ãƒ»ãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
[![Image from Gyazo](https://i.gyazo.com/febc5aa717c86877afd72723f66a8202.png)](https://gyazo.com/febc5aa717c86877afd72723f66a8202)


##### ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æŒ‡å®š 
details ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã§S3ã‚’é¸æŠ
ãƒ»`S3`ã‚’é¸æŠ â‡¨ æ¬¡ã¸
[![Image from Gyazo](https://i.gyazo.com/5e4e0da01d4acfa03fd7848f3e8b5137.png)](https://gyazo.com/5e4e0da01d4acfa03fd7848f3e8b5137)


details ãƒªã‚¹ãƒˆã€èª­ã¿å–ã‚Šã€æ›¸ãè¾¼ã¿ã€è¨±å¯ã®ç®¡ç†ã€ã‚¿ã‚°ä»˜ã‘ã‚’ãã‚Œãã‚Œé¸æŠã™ã‚‹
ãƒ»`S3`ã‚¿ãƒ–ã‚’å±•é–‹
[![Image from Gyazo](https://i.gyazo.com/240866e04a79a0f7808f08a6dd17d016.png =400x)](https://gyazo.com/240866e04a79a0f7808f08a6dd17d016)

ãƒ»ãƒªã‚¹ãƒˆ â‡¨ `ListBucket`
[![Image from Gyazo](https://i.gyazo.com/f740a5c9da323791081058f83808b88c.png)](https://gyazo.com/f740a5c9da323791081058f83808b88c)
ãƒ»èª­ã¿å–ã‚Š â‡¨ `GetObject`
[![Image from Gyazo](https://i.gyazo.com/9666c63fd34673eb74d6348afabeb0cd.png)](https://gyazo.com/9666c63fd34673eb74d6348afabeb0cd)
ãƒ»æ›¸ãè¾¼ã¿ â‡¨ `DeleteObject`ã¨`PutObject`
[![Image from Gyazo](https://i.gyazo.com/72c380078a68018d0dd6aa0dec1ec715.png)](https://gyazo.com/72c380078a68018d0dd6aa0dec1ec715)
ãƒ»è¨±å¯ã®ç®¡ç† â‡¨ `PutObjectAcl`
[![Image from Gyazo](https://i.gyazo.com/9a9fb37c4800c3d6af2dc5d8964fe744.png)](https://gyazo.com/9a9fb37c4800c3d6af2dc5d8964fe744)


details ARNã‚’è¿½åŠ ã‚’ã™ã‚‹
ãƒ»bucketã®ã¿`ARNã‚’è¿½åŠ `ã‚’é¸æŠã—è¨˜è¼‰
[![Image from Gyazo](https://i.gyazo.com/7ae04ecde20e8cb78ff4b316d6159829.png)](https://gyazo.com/7ae04ecde20e8cb78ff4b316d6159829)
ãƒ»ãƒªã‚½ãƒ¼ã‚¹ãƒã‚±ãƒƒãƒˆåã«ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆåã‚’è¨˜è¼‰ã™ã‚‹ï¼ˆãƒªã‚½ãƒ¼ã‚¹ARNã¯è‡ªå‹•ã§è¨˜è¼‰ã•ã‚Œã‚‹ï¼‰â‡¨ `ARNã‚’è¿½åŠ ` â‡¨ æ¬¡ã¸
[![Image from Gyazo](https://i.gyazo.com/5f045cde47b7a72b3a7d479c5e4b544f.png)](https://gyazo.com/5f045cde47b7a72b3a7d479c5e4b544f)


##### ãƒãƒªã‚·ãƒ¼ã®è©³ç´°
details ãƒãƒªã‚·ãƒ¼åã‚’è¨˜è¼‰
ãƒ»ãƒãƒªã‚·ãƒ¼åã®ã¿è¨˜è¼‰ï¼ˆèª¬æ˜-ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¸è¦ï¼‰
[![Image from Gyazo](https://i.gyazo.com/5dce4f24180631d31715f89ef4a90bd6.png)](https://gyazo.com/5dce4f24180631d31715f89ef4a90bd6)
ãƒ»ãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
[![Image from Gyazo](https://i.gyazo.com/7fc7aa9a0c8677eab158bc1d0411cef7.png)](https://gyazo.com/7fc7aa9a0c8677eab158bc1d0411cef7)


# IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
##### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ– â‡¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
details å‚è€ƒç”»åƒ
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ–
[![Image from Gyazo](https://i.gyazo.com/7c266df10c6d5fbf428e66415adde700.png =200x)](https://gyazo.com/7c266df10c6d5fbf428e66415adde700)
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
[![Image from Gyazo](https://i.gyazo.com/a01df4003b9b0b7333c9012720ab3ec1.png)](https://gyazo.com/a01df4003b9b0b7333c9012720ab3ec1)


##### è¨±å¯ã‚’è¨­å®š
details å‚è€ƒç”»åƒ
ãƒ»`ãƒãƒªã‚·ãƒ¼ã‚’ç›´æ¥ã‚¢ã‚¿ãƒƒãƒã™ã‚‹`ã‚’é¸æŠã™ã‚‹ â‡¨  æ¤œç´¢æ¬„ã§å…ˆã»ã©ä½œæˆã—ãŸ`IAMãƒãƒªã‚·ãƒ¼`ã‚’æ¤œç´¢ã™ã‚‹
  ã€€â‡¨ ãƒãƒªã‚·ãƒ¼ã‚’é¸æŠ â‡¨ `æ¬¡ã¸`
[![Image from Gyazo](https://i.gyazo.com/7fb0df81e787b9937874419b81d34585.png)](https://gyazo.com/7fb0df81e787b9937874419b81d34585)
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ã€è¨±å¯ã®æ¦‚è¦ã‚’ç¢ºèªã—ã¦ â‡¨ `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ`
[![Image from Gyazo](https://i.gyazo.com/50439ac722d4f3c3d6de0bfe6c073834.png)](https://gyazo.com/50439ac722d4f3c3d6de0bfe6c073834)



# ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆ
##### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ– â‡¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠ
details å‚è€ƒç”»åƒ
[![Image from Gyazo](https://i.gyazo.com/b16ee53a08dc263494b3060138746709.png =400x)](https://gyazo.com/b16ee53a08dc263494b3060138746709)

##### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼æƒ…å ±ã‚¿ãƒ– â‡¨ ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆ
details å‚è€ƒç”»åƒ
ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼æƒ…å ±ã‚¿ãƒ–
[![Image from Gyazo](https://i.gyazo.com/b8a8b26f7c86b0e16f7d6bc8f455f9b1.png)](https://gyazo.com/b8a8b26f7c86b0e16f7d6bc8f455f9b1)
ãƒ»ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆ
[![Image from Gyazo](https://i.gyazo.com/aa86d8bc0bf3add280d5f6c575eb0d13.png)](https://gyazo.com/aa86d8bc0bf3add280d5f6c575eb0d13)


##### ä¸»è¦ãªãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ä»£æ›¿æ¡ˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã®è¨­å®š â‡¨ èª¬æ˜ã‚¿ã‚°ã‚’è¨­å®š-ã‚ªãƒ—ã‚·ãƒ§ãƒ³
details å‚è€ƒç”»åƒ
ãƒ»`AWS ã®å¤–éƒ¨ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³`ã‚’é¸æŠã™ã‚‹ â‡¨ `æ¬¡ã¸`
[![Image from Gyazo](https://i.gyazo.com/48bfe08dab92d02dfb9acd0bf362205d.png)](https://gyazo.com/48bfe08dab92d02dfb9acd0bf362205d)
ãƒ»`èª¬æ˜ã‚¿ã‚°ã‚’è¨­å®š-ã‚ªãƒ—ã‚·ãƒ§ãƒ³`ã¯ä¸è¦ãªã®ã§ãã®ã¾ã¾`ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆ`
[![Image from Gyazo](https://i.gyazo.com/12891e0c6dc9ac9c44ae5ea46def93e6.png)](https://gyazo.com/12891e0c6dc9ac9c44ae5ea46def93e6)


# ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã®è¨­å®š
##### ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆã¸ç§»å‹•ã—`ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚¿ãƒ–`ã‚’é¸æŠã™ã‚‹ â‡¨ ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã®`ç·¨é›†`ã‚’é¸æŠ
details å‚è€ƒç”»åƒ
ãƒ»ç”»åƒã®ã‚ˆã†ã«è¨˜è¼‰ã—ã¾ã—ãŸã€‚
[![Image from Gyazo](https://i.gyazo.com/81e5ec38876670e8d189de0dbf240c92.png =600x)](https://gyazo.com/81e5ec38876670e8d189de0dbf240c92)
```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã‹ã‚‰ARNã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘"
      },
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::ãƒã‚±ãƒƒãƒˆå",
        "arn:aws:s3:::ãƒã‚±ãƒƒãƒˆå/*"
      ]
    }
  ]
}
```


##### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã‹ã‚‰ARNã‚’ã‚³ãƒ”ãƒ¼
details å‚è€ƒç”»åƒ
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ–ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠ
[![Image from Gyazo](https://i.gyazo.com/b16ee53a08dc263494b3060138746709.png =400x)](https://gyazo.com/b16ee53a08dc263494b3060138746709)
ãƒ»ã“ã¡ã‚‰ã‚’ã‚³ãƒ”ãƒ¼
[![Image from Gyazo](https://i.gyazo.com/3b1567cc6464258972eae45741bc654d.png)](https://gyazo.com/3b1567cc6464258972eae45741bc654d)


# ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¨˜è¼‰

## gem 'aws-sdk-s3'ã®è¿½åŠ 
details Gemfile
ãƒ»è¿½è¨˜
```
gem 'aws-sdk-s3'
```
ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
$ bundle install
```




## config/credentials.yml.enc ã¸ã®è¨˜è¼‰ï¼ˆéš ã—ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
##### è¨˜è¼‰å†…å®¹
details ï¼”ã¤ã‚’è¨˜è¼‰ã—ã¦ã„ã
`ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼`ã€`ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼`ã€`ãƒªãƒ¼ã‚¸ãƒ§ãƒ³`ã€`ãƒã‚±ãƒƒãƒˆå`




##### ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‹ã‚‰ç›´æ¥è¨˜è¼‰ãŒã§ããªã„ã®ã§`vim`ã§è¨˜è¼‰ã—ã¦ã„ã
details EDITOR="vim" rails credentials:edit
ãƒ»ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Š
```
$ docker-compose exec web bash
```
ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—vimã§é–‹ã
```
$ EDITOR="vim" rails credentials:edit
```
ãƒ»ã“ã®ã‚ˆã†ãªè¨˜è¼‰ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã†ã®ã§...
```
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»çœç•¥ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»


```
å¿…è¦äº‹é …ã‚’è¿½è¨˜ã™ã‚‹ï¼ˆ`:`ã®å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚„æ”¹è¡Œã«æ°—ã‚’ã¤ã‘ã‚‹ï¼‰
```
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»çœç•¥ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»

aws:
  access_key_id: ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
  secret_access_key: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
  region: ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  bucket: ãƒã‚±ãƒƒãƒˆå
```


##### ä¿å­˜ã‚³ãƒ¼ãƒ‰ã®ç¢ºèªæ–¹æ³•
details ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç¢ºèªï¼ˆRails.application.credentials.awsï¼‰
ãƒ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã
```
$ rails c
```
ãƒ»`Rails.application.credentials.aws`
```
irb(main):001> Rails.application.credentials.aws
=> {:access_key_id=>"ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼", :secret_access_key=>"ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼", 
    :region=>"ãƒªãƒ¼ã‚¸ãƒ§ãƒ³", :bucket=>"ãƒã‚±ãƒƒãƒˆå"}
```


details ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ç¢ºèªï¼ˆrails credentials:showï¼‰
ãƒ»ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹
```
$ docker-compose exec web bash 
```
ãƒ»`rails credentials:show`
```
root@b7f741d3e5aa:/myapp# rails credentials:show
```
ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ¼ãƒ‰ãŒãã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã‚‹
```
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»çœç•¥ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»

aws:
  access_key_id: ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
  secret_access_key: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
  region: ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  bucket: ãƒã‚±ãƒƒãƒˆå
```



##### ä¿å­˜ã«æˆåŠŸã—ãŸå ´åˆã¨å¤±æ•—ã—ãŸå ´åˆã®è¡¨ç¤º
details å‚è€ƒç”»åƒ
ãƒ»ä¿å­˜ã«æˆåŠŸã—ãŸè¡¨ç¤º
[![Image from Gyazo](https://i.gyazo.com/f006631decadbae05ed1eecc7f4ae9f2.png)](https://gyazo.com/f006631decadbae05ed1eecc7f4ae9f2)
ãƒ»ä¿å­˜ã«å¤±æ•—ã—ãŸè¡¨ç¤ºï¼ˆç”»åƒã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¨ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ï¼‰
[![Image from Gyazo](https://i.gyazo.com/e0ada61f07dca84cf6a701da093f7b2f.png)](https://gyazo.com/e0ada61f07dca84cf6a701da093f7b2f)


message alert
ä¿å­˜ã«å¤±æ•—ã—ãŸéš›ã¯ãã®ã¾ã¾Dockerã‚’é–‰ã˜ã¦ã—ã¾ã†ã¨ã€
`ã‚¨ãƒ©ãƒ¼ã§DockerãŒèµ·å‹•ã§ããªã„`â‡¨`ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Œãªã„`â‡¨`å…¥ã‚Œãªã„ã®ã§vimã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£ãŒã§ããªã„`
â‡¨`ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã§ããªã„`ã®ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ã¦ã—ã¾ã†ã€‚

ãã®æ™‚ã¯`config/credentials.yml.enc`ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã€
ã‚‚ã†ä¸€åº¦`EDITOR="vim" rails credentials:edit`ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ã‚„ã‚Šç›´ã™ã€‚



## config/storage.yml ã¸ã®è¨˜è¼‰

details è¨˜è¼‰æ–¹æ³•
ãƒ»éš ã—ãƒ•ã‚¡ã‚¤ãƒ«`config/credentials.yml.enc`ã‚’æ­£ã—ãå‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã€
ã€€`ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ`ã¨`æ”¹è¡Œ`ã«æ°—ã‚’ã¤ã‘ã‚‹ã€‚

config/storage.yml
```
local:
  service: S3
  access_key_id: <%= ENV['AWS_ACCESS_KEY_ID'] %>
  secret_access_key: <%= ENV['AWS_SECRET_ACCESS_KEY'] %>
  region: <%= ENV['AWS_REGION'] %>
  bucket: <%= ENV['AWS_BUCKET'] %>

amazon:
  service: S3
  access_key_id: <%= ENV['AWS_ACCESS_KEY_ID'] %>
  secret_access_key: <%= ENV['AWS_SECRET_ACCESS_KEY'] %>
  region: <%= ENV['AWS_REGION'] %>
  bucket: <%= ENV['AWS_BUCKET'] %>
```


## config/environments/development.rb ã¸ã®è¨˜è¼‰

details è¿½è¨˜ã‚³ãƒ¼ãƒ‰
config.active_storage.service = :amazon


## config/environments/production.rb ã¸ã®è¨˜è¼‰

details è¿½è¨˜ã‚³ãƒ¼ãƒ‰
ãƒ»`development.rbãƒ•ã‚¡ã‚¤ãƒ«`ã¨åŒæ§˜ã®è¿½è¨˜ã‚’ã™ã‚‹
config.active_storage.service = :amazon


# Herokuã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰
##### Herokuã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€`è¨­å®š`â‡¨`è¨­å®šå¤‰æ•°ã€€`â‡¨`éµ`ã¨`ä¾¡å€¤`ã«å€¤ã‚’å…¥åŠ›ã—`è¿½åŠ `
details æ‰‹é †
ãƒ»è¨­å®šã‚¿ãƒ–
[![Image from Gyazo](https://i.gyazo.com/914ec4a813e92fe2e3fdebfd27d68212.png)](https://gyazo.com/914ec4a813e92fe2e3fdebfd27d68212)
ãƒ»`éµ`ã¨`ä¾¡å€¤`ã«å€¤ã‚’å…¥åŠ›ã—`è¿½åŠ `
[![Image from Gyazo](https://i.gyazo.com/6e65aa2a63db2e789ddfd5d8473d18ae.png)](https://gyazo.com/6e65aa2a63db2e789ddfd5d8473d18ae)
ãƒ»ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ï¼ˆ`config/storage.ymlãƒ•ã‚¡ã‚¤ãƒ«`ãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã«æ­£ã—ãè¨˜è¼‰ï¼‰
[![Image from Gyazo](https://i.gyazo.com/8e476b902b15109233ed4534a1cd7a1a.png)](https://gyazo.com/8e476b902b15109233ed4534a1cd7a1a)

##### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰Herokuã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã™ã‚‹
details heroku config
ãƒ»Herokuã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
```
$ heroku config
```
ãƒ»æ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```
AWS_ACCESS_KEY_ID:        ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
AWS_BUCKET:               ãƒã‚±ãƒƒãƒˆå
AWS_REGION:               ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
AWS_SECRET_ACCESS_KEY:    ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
```


# é–‹ç™ºç’°å¢ƒã«ã‚‚ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã™ã‚‹
##### éš ã—ãƒ•ã‚¡ã‚¤ãƒ«`.env`ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã™ã‚‹
details .env
```
AWS_ACCESS_KEY_ID=ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
AWS_SECRET_ACCESS_KEY=ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
AWS_REGION=ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
AWS_BUCKET=ãƒã‚±ãƒƒãƒˆå
```

